SET ESCAPE ON
ON ESCAPE DO SALIDA
STORE SPACE(1) TO WDOCDES
STORE SPACE(1) TO WDOCESP
STORE SPACE(1) TO WESPDES
STORE SPACE(1) TO WDOCCOL
STORE SPACE(1) TO WDOCSAS

STORE SPACE(1) TO QTIPPAC
STORE SPACE(1) TO QTIPDES
STORE SPACE(1) TO QORGADES
STORE SPACE(1) TO QNIV1DES
STORE SPACE(1) TO QXCODPAC
STORE SPACE(1) TO QNUMHIS
STORE SPACE(1) TO QSEXO
STORE SPACE(1) TO QNOMBRE
STORE SPACE(1) TO QNACIMIENTO
STORE SPACE(1) TO QLUGARNAC
STORE SPACE(1) TO QUNDDAT
STORE SPACE(1) TO QVALNOR

DO WHILE .T.
   STORE 0   TO WPAGINA
   STORE 100 TO WLINEA
   IF WSALIDA = 1
      STORE 20 TO WSALTO
      @ 0,0 CLEAR
   ELSE
      SET DEVI TO PRINT
      STORE 60 TO WSALTO
   ENDIF
   SELECT HISGEN
   IF WCODPAC<>SPACE(14)
      SET ORDER TO 1
      SEEK WCODPAC
      IF .NOT.FOUND()
         SET DEVI TO SCRE
         STORE "NO HAY DATOS EN HISTORIA PARA PACIENTE: "+WCODPAC TO WTEXT
         DO AVISO WITH WTEXT
         EXIT
      ENDIF
   ELSE
      SET ORDER TO 2
      SEEK WCODDOC
      IF .NOT.FOUND()
         SET DEVI TO SCRE
         STORE "NO HAY DATOS EN HISTORIA PARA AUTOR: "+WCODDOC TO WTEXT
         DO AVISO WITH WTEXT
         EXIT
      ENDIF
   ENDIF
   STORE "**************" TO WRUPPAC
   DO WHILE .NOT. EOF()
      STORE .F. TO WFLAGRUPDP
      IF WCODPAC<>SPACE(14).AND.CODPAC<>WCODPAC
         EXIT
      ENDIF
      IF CODPAC<>WRUPPAC
         STORE SPACE(1) TO QTIPPAC
         STORE SPACE(1) TO QTIPDES
         STORE SPACE(1) TO QORGADES
         STORE SPACE(1) TO QNIV1DES
         STORE SPACE(1) TO QXCODPAC
         STORE SPACE(1) TO QNUMHIS
         STORE SPACE(1) TO QSEXO
         STORE SPACE(1) TO QNOMBRE
         STORE SPACE(1) TO QNACIMIENTO
         STORE SPACE(1) TO QLUGARNAC
         STORE SPACE(1) TO QUNDDAT
         STORE SPACE(1) TO QVALNOR
         DO GETPAC
         IF QTIPPAC=SPACE(1)
            SELECT HISGEN
            SKIP
            LOOP
         ENDIF
         SELECT HISGEN
         STORE CODPAC TO WRUPPAC
         STORE .T. TO WFLAGRUPDP
         STORE 0   TO WPAGINA
         STORE 100 TO WLINEA
      ENDIF
      *** FILTROS DE DATOS GENERALES
      IF WTIPPAC<>"T".AND.WTIPPAC<>QTIPPAC
         SELECT HISGEN
         SKIP
         LOOP
      ENDIF
      IF WSEXO<>"T".AND.WSEXO<>QSEXO
         SELECT HISGEN
         SKIP
         LOOP
      ENDIF
      IF WNACDESDE<>CTOD("  -  -  ").AND.WNACDESDE>QNACIMIENTO
         SELECT HISGEN
         SKIP
         LOOP
      ENDIF
      IF WNACHASTA<>CTOD("  -  -  ").AND.WNACHASTA<QNACIMIENTO
         SELECT HISGEN
         SKIP
         LOOP
      ENDIF
      IF WFLAGHIST="I".AND..NOT.WFLAGREP.AND.FLAGRP
         SELECT HISGEN
         SKIP
         LOOP
      ENDIF
      *IF WFLAGRUPDP
      *   *********************************************
      *   * IMPRIME DATOS GENERALES DEL PACIENTE AQUI *
      *   *********************************************
      *   DO HISDPER
      *   STORE .F. TO WFLAGRUPDP
      *ENDIF
      *** FILTROS DE HISGEN
      SELECT HISGEN
      IF WDESDE<>CTOD("  -  -  ").AND.FECACT<WDESDE
         SELECT HISGEN
         SKIP
         LOOP
      ENDIF
      IF WHASTA<>CTOD("  -  -  ").AND.FECACT>WHASTA
         SELECT HISGEN
         SKIP
         LOOP
      ENDIF
      IF WCODDOC<>SPACE(3).AND.WCODDOC<>CODDOC
         SELECT HISGEN
         SKIP
         LOOP
      ENDIF
      IF WGRUPO<>SPACE(2)
         IF WGRUPO<>CODACT
            SELECT HISGEN
            SKIP
            LOOP
         ENDIF
         IF WNUMACT<>0.AND.WNUMACT<>NUMACT
            SELECT HISGEN
            SKIP
            LOOP
         ENDIF
      ENDIF
      IF WFLAGRUPDP
         *********************************************
         * IMPRIME DATOS GENERALES DEL PACIENTE AQUI *
         *********************************************
         DO HISDPER
         STORE .F. TO WFLAGRUPDP
      ENDIF
      ***********************************************
      * IMPRIME DATOS GENERALES DE LA HISTORIA AQUI *
      ***********************************************
      DO HISDGEN
      STORE HISGEN.CODPAC+HISGEN.CODACT+STR(HISGEN.NUMACT,4) TO WCLAVEDET
      SELECT HISDET
      SEEK WCLAVEDET
      IF .NOT.FOUND()
         SELECT HISGEN
         SKIP
         LOOP
      ENDIF
      STORE "*****"    TO WRUPSUB
      STORE "********" TO WRUPREN
      DO WHILE .NOT. EOF() .AND.(CODPAC+CODACT+STR(NUMACT,4))=WCLAVEDET
         STORE SUBSTR(CODDAT,1,5) TO QCODSUB
         STORE SUBSTR(CODDAT,1,8) TO QCODREN
         STORE CODDAT             TO QCODDAT
         *** FILTROS DE HISDET
         IF WCODSUB<>SPACE(3).AND.(WGRUPO+WCODSUB)<>QCODSUB
            SELECT HISDET
            SKIP
            LOOP
         ENDIF
         IF WCODREN<>SPACE(3).AND.(WGRUPO+WCODSUB+WCODREN)<>QCODREN
            SELECT HISDET
            SKIP
            LOOP
         ENDIF
         IF WCODTAB<>SPACE(3).AND.(WGRUPO+WCODSUB+WCODREN+WCODTAB)<>QCODDAT
            SELECT HISDET
            SKIP
            LOOP
         ENDIF
         STORE AT(RTRIM(LTRIM(UPPER(WVALDAT))),UPPER(DATREN)) TO WPOSDAT
         IF WVALDAT<>SPACE(40).AND.WPOSDAT=0
            SELECT HISDET
            SKIP
            LOOP
         ENDIF
         IF WRUPSUB<>QCODSUB
            ************************************
            * IMPRIME TITULO DEL SUBGRUPO AQUI *
            ************************************
            STORE QCODSUB TO WRUPSUB
            DO HISDSUB
         ENDIF
         IF WRUPREN<>QCODREN
            ***********************************
            * IMPRIME TITULO DEL RENGLON AQUI *
            ***********************************
            STORE QCODREN TO WRUPREN
            DO HISDREN
         ENDIF
         ************************************************
         * IMPRIME DATOS DETALLADOS DE LA HISTORIA AQUI *
         ************************************************
         DO HISDDET
         SELECT HISDET
         IF .NOT. EOF()
            SKIP
         ENDIF
      ENDDO
      SELECT HISGEN
      *** IMPRESION SELECTIVA PARA INGRESOS HOSPITALARIOS
      IF WFLAGHIST="I".AND.RECLOC()
         REPLACE FLAGRP WITH .T.
         UNLOCK ALL
      ENDIF
      ***
      SKIP
   ENDDO
   EXIT
ENDDO

*** AUTOR
IF WSALIDA=1
   STORE WLINEA+1 TO WLINEA
ELSE
   STORE WLINEA+5 TO WLINEA
ENDIF
STORE .F. TO WFLAGSALTO
DO SALTO
IF WFLAGSALTO
   STORE 1 TO WLINEA
   @ WLINEA,40-(LEN(RTRIM(QNOMBRE))/2) SAY QNOMBRE
   @ WLINEA,70                         SAY "Pag."+ALLTRIM(STR(WPAGINA,3))
   STORE WLINEA + 1 TO WLINEA
   @ WLINEA,00                         SAY REPLICATE("-",80)
ENDIF
IF WFORMATO=1
   STORE WLINEA + 1 TO WLINEA
   @ WLINEA,40 SAY "---------------------------"
   STORE WLINEA+1 TO WLINEA
   @ WLINEA,40 SAY ALLTRIM(WDOCDES)
   STORE WLINEA+1 TO WLINEA
   @ WLINEA,40 SAY ALLTRIM(WESPDES)
   STORE WLINEA+1 TO WLINEA
   @ WLINEA,40 SAY "No.Colegio :"+WDOCCOL
   STORE WLINEA+1 TO WLINEA
   @ WLINEA,40 SAY "No.M.S.A.S.:"+WDOCSAS
ELSE
   STORE WLINEA + 1 TO WLINEA
   @ WLINEA,40 SAY "---------------------------"
   STORE WLINEA+1 TO WLINEA
   @ WLINEA,40 SAY ALLTRIM(WDOCDES)
   STORE WLINEA+1 TO WLINEA
   @ WLINEA,40 SAY ALLTRIM(WESPDES)
   STORE WLINEA+1 TO WLINEA
   @ WLINEA,40 SAY "No.Colegio :"+WDOCCOL
   STORE WLINEA+1 TO WLINEA
   @ WLINEA,40 SAY "No.M.S.A.S.:"+WDOCSAS
ENDIF
IF WSALIDA = 2
   SET DEVI TO SCRE
   EJECT
ELSE
   STORE "OPRIMA (Ù) PARA FINALIZAR" TO TEX
   STORE CHR(13) TO WCH
   DO PREGUNTA
   @ 0,0 CLEAR
ENDIF
SELECT HISGEN
SET ORDER TO 1
ON ESCAPE
SET ESCAPE OFF
RETURN
********************************************************************************
***********
PROC GETPAC
***********
STORE HISGEN.CODPAC TO QCODPAC
SELECT AFIAFI
SET ORDER TO AFIAFI1
SEEK QCODPAC
IF .NOT. FOUND()
   SELECT SYSPAC
   SET ORDER TO SYSPAC
   SEEK QCODPAC
   IF .NOT. FOUND()
      RETURN
   ELSE
      STORE "N"                                               TO QTIPPAC
      STORE "No afiliado"                                     TO QTIPDES
      STORE ALLTRIM(SUBSTR(CODPAC,1,10))+"-"+ALLTRIM(SUBSTR(CODPAC,11,4)) TO QXCODPAC
      STORE RTRIM(PAPELLIDO)+" "+RTRIM(SAPELLIDO)+" "+RTRIM(PNOMBRE)+" "+RTRIM(SNOMBRE)            TO QNOMBRE
      STORE SEXO                                              TO QSEXO
      STORE NACIMIENTO                                        TO QNACIMIENTO
      STORE LUGARNAC                                          TO QLUGARNAC
      STORE HISTORIA                                          TO QNUMHIS
      STORE SPACE(1)                                          TO QORGADES
      STORE SPACE(1)                                          TO QNIV1DES
   ENDIF
ELSE
   STORE "A"                                                  TO QTIPPAC
   IF VAL(SUBSTR(QCODPAC,11,4))=0
      STORE "Afiliado-Titular   "                             TO QTIPDES
   ELSE
      STORE "Afiliado-Carga Fam."                             TO WTIPDES
   ENDIF
   STORE ALLTRIM(CEDTITU)+"-"+ALLTRIM(CARGA)                  TO QXCODPAC
   STORE RTRIM(PAPELLIDO)+" "+RTRIM(SAPELLIDO)+" "+RTRIM(PNOMBRE)+" "+ALLTRIM(SNOMBRE)               TO QNOMBRE
   STORE SEXO                                                 TO QSEXO
   STORE NACIMIENTO                                           TO QNACIMIENTO
   STORE LUGARNAC                                             TO QLUGARNAC
   STORE HISTORIA                                             TO QNUMHIS
   SELECT 24
   USE AFITITU INDEX AFITITU1
   SEEK SUBSTR(QCODPAC,1,10)
   IF FOUND()
      STORE ORGA                                              TO WORGA
      STORE NIVORG1                                           TO WNIV1
   ELSE
      STORE SPACE(1)                                          TO WORGA
      STORE SPACE(1)                                          TO WNIV1
   ENDIF
   SELECT 25
   USE AFIORGA INDEX AFIORGA
   SEEK WORGA
   IF FOUND()
      STORE DESCRI                                            TO QORGADES
   ENDIF
   SEEK WORGA+WNIV1
   IF FOUND()
      STORE DESCRI                                            TO QNIV1DES
   ENDIF
   SELECT 24
   USE
   SELECT 25
   USE
ENDIF
RETURN
**********
PROC SALTO
**********
IF WLINEA >= WSALTO
   STORE .T. TO WFLAGSALTO
   STORE WPAGINA + 1 TO WPAGINA
   IF WSALIDA=1 .AND. WPAGINA<>1
      STORE "OPRIMA (Ù) PARA CONTINUAR" TO TEX
      STORE CHR(13) TO WCH
      DO PREGUNTA
      @ 0,0 CLEAR
   ENDIF
ELSE
   STORE .F. TO WFLAGSALTO
ENDIF
RETURN
************
PROC HISDPER
************
IF QTIPPAC="A"
   STORE AFIAFI.CEDAFI                 TO QCEDPAC
   STORE INT((DATE()-QNACIMIENTO)/365) TO QEDAD
   STORE AFIAFI.EDOCIVIL               TO QEDOCIVIL
   STORE AFIAFI.DIRECCION              TO QDIRECCION
   STORE AFIAFI.TELEFONO               TO QTELEFONO
   STORE AFIAFI.ALERGICO               TO QALERGICO
   STORE AFIAFI.EMERGENCIA             TO QEMERGENCIA
ELSE
   STORE SUBSTR(SYSPAC.CODPAC,1,10)    TO QCEDPAC
   STORE INT((DATE()-QNACIMIENTO)/365) TO QEDAD
   STORE SYSPAC.EDOCIVIL               TO QEDOCIVIL
   STORE SYSPAC.DIRECCION              TO QDIRECCION
   STORE SYSPAC.TELEFONO               TO QTELEFONO
   STORE AFIAFI.ALERGICO               TO QALERGICO
   STORE SYSPAC.EMERGENCIA             TO QEMERGENCIA
ENDIF
STORE 100 TO WLINEA
DO SALTO
IF WFORMATO=1
   @ 01,00 SAY CHR(14)+QQWW
   @ 01,00 SAY CHR(14)+QQWW
   @ 04,55 SAY "HISTORIA No. "+ALLTRIM(QNUMHIS)
   @ 05,00 SAY REPLICATE("-",80)
   @ 06,22 SAY CHR(14)+"HISTORIA MEDICA"
   @ 07,00 SAY REPLICATE("-",80)
   @ 08,00 SAY "DATOS GENERALES DEL PACIENTE"
   @ 08,00 SAY "DATOS GENERALES DEL PACIENTE"
   @ 10,00 SAY "Codigo ..............: "+QXCODPAC+"  "+QTIPDES
   @ 11,00 SAY "Nombre ..............: "+QNOMBRE
   @ 12,00 SAY "Cedula ..............: "+QCEDPAC
*  @ 13,00 SAY "Organismo-Cliente ...: "+SUBSTR(QORGADES,1,20)+"-"+SUBSTR(QNIV1DES,1,20)
*  @ 14,00 SAY "Sexo ................: "+QSEXO
*  @ 15,00 SAY "Nacimiento Lug y Fec.: "+QLUGARNAC+"  "+DTOC(QNACIMIENTO)
*  @ 16,00 SAY "Edad ................:"+STR(QEDAD,3)
*  @ 17,00 SAY "Estado civil ........: "+QEDOCIVIL
*  @ 18,00 SAY "Direccion ...........: "+QDIRECCION
*  @ 19,00 SAY "Telefono ............: "+QTELEFONO
*  @ 20,00 SAY "Alergico a ..........: "+QALERGICO
*  @ 21,00 SAY "Emergencia Nom, Tel..: "+QEMERGENCIA
   STORE 12 TO WLINEA
ELSE
   @ 01,00 SAY CHR(14)+QQWW
   @ 01,00 SAY CHR(14)+QQWW

   @ 02,00 SAY REPLICATE("-",80)
   IF WUSERUBI="LAB"
      @ 03,22 SAY CHR(14)+"INFORME DE LABORATORIO"
   ELSE
      @ 03,22 SAY CHR(14)+"INFORME MEDICO"
   ENDIF
   @ 04,00 SAY REPLICATE("-",80)
   @ 05,00 SAY "Nombre : "+ALLTRIM(QNOMBRE)+" "+QTIPDES
   @ 06,00 SAY "Codigo : "+ALLTRIM(QXCODPAC)
   @ 06,30 SAY "Historia : "+ALLTRIM(QNUMHIS)
   @ 06,55 SAY "Cedula : "+ALLTRIM(QCEDPAC)
   STORE 06 TO WLINEA
ENDIF
RETURN
************
PROC HISDGEN
************
SELECT HISGRU
SEEK HISGEN.CODACT
IF .NOT.FOUND()
   STORE "NO REGISTRADO" TO WGRUDES
ELSE
   STORE DESGRU          TO WGRUDES
ENDIF
SELECT SYSMED
SEEK HISGEN.CODDOC
IF .NOT.FOUND()
   STORE "NO REGISTRADO" TO WDOCDES
   STORE "   "           TO WDOCESP
   STORE "   "           TO WDOCCOL
   STORE "   "           TO WDOCSAS
ELSE
   STORE NOMBRE          TO WDOCDES
   STORE ESPECI          TO WDOCESP
   STORE COLEGIO         TO WDOCCOL
   STORE MSAS            TO WDOCSAS
ENDIF
SELECT SYSESP
SEEK WDOCESP
IF .NOT.FOUND()
   STORE "NO REGISTRADA" TO WESPDES
ELSE
   STORE DESCRI          TO WESPDES
ENDIF
IF WFORMATO=1
   STORE WLINEA+1 TO WLINEA
   STORE .F. TO WFLAGSALTO
   DO SALTO
   IF WFLAGSALTO
      STORE 1 TO WLINEA
      @ WLINEA,40-(LEN(RTRIM(QNOMBRE))/2) SAY QNOMBRE
      @ WLINEA,70                         SAY "Pag."+ALLTRIM(STR(WPAGINA,3))
      STORE WLINEA + 1 TO WLINEA
      @ WLINEA,00                         SAY REPLICATE("-",80)
   ENDIF
   STORE WLINEA + 1 TO WLINEA
   @ WLINEA,00                            SAY REPLICATE("-",80)
   STORE WLINEA + 1 TO WLINEA
   STORE " Actividad Nro. "+ALLTRIM(STR(HISGEN.NUMACT,4))+":  "+ALLTRIM(WGRUDES)+" De fecha :"+DTOC(HISGEN.FECACT) TO WACTDES
   @ WLINEA,40-(LEN(RTRIM(WACTDES))/2)    SAY WACTDES
   @ WLINEA,40-(LEN(RTRIM(WACTDES))/2)    SAY WACTDES
   STORE WLINEA + 1 TO WLINEA
   STORE " Especialidad: "+ALLTRIM(WDOCESP)+"   Doctor(a): "+ALLTRIM(WDOCDES) TO WACTDES
   @ WLINEA,40-(LEN(RTRIM(WACTDES))/2)    SAY WACTDES
   @ WLINEA,40-(LEN(RTRIM(WACTDES))/2)    SAY WACTDES
   STORE WLINEA+1 TO WLINEA
   @ WLINEA,00                            SAY REPLICATE("-",80)
ELSE
   STORE WLINEA + 1 TO WLINEA
   STORE .F. TO WFLAGSALTO
   DO SALTO
   IF WFLAGSALTO
      DO HISDPER
   ENDIF

   STORE WLINEA + 1 TO WLINEA
   @ WLINEA,55                            SAY "Fecha  : "+DTOC(HISGEN.FECACT)
   STORE WLINEA + 1 TO WLINEA
   @ WLINEA,00                            SAY REPLICATE("-",80)
   STORE WLINEA + 1 TO WLINEA
   STORE ALLTRIM(WGRUDES) TO WACTDES
   @ WLINEA,00 SAY CHR(14)+WACTDES
   STORE WLINEA+1 TO WLINEA
   @ WLINEA,00                            SAY REPLICATE("-",80)
ENDIF
RETURN
************
PROC HISDSUB
************
SELECT HISSUB
SEEK WRUPSUB
IF FOUND()
   STORE DESSUB     TO QDESSUB
   STORE UNDSUB     TO QUNDDAT
   STORE VALNOR     TO QVALNOR
   STORE WLINEA + 1 TO WLINEA
   STORE .F. TO WFLAGSALTO
   DO SALTO
   IF WFLAGSALTO
      STORE 1 TO WLINEA
      @ WLINEA,40-(LEN(RTRIM(QNOMBRE))/2) SAY QNOMBRE
      @ WLINEA,70                         SAY "Pag."+ALLTRIM(STR(WPAGINA,3))
      STORE WLINEA + 1 TO WLINEA
      @ WLINEA,00                            SAY REPLICATE("-",80)
      STORE WLINEA + 1 TO WLINEA
   ENDIF
   IF WFORMATO=1
      @ WLINEA,00 SAY CHR(14)+QDESSUB
      @ WLINEA,00 SAY CHR(14)+QDESSUB
   ELSE
      @ WLINEA,00 SAY QDESSUB
      @ WLINEA,00 SAY QDESSUB
   ENDIF
ENDIF
RETURN
************
PROC HISDREN
************
SELECT HISREN
SEEK WRUPREN
IF FOUND()
   STORE DESREN     TO QDESREN
   STORE UNDREN     TO QUNDDAT
   STORE VALNOR     TO QVALNOR
   STORE WLINEA + 1 TO WLINEA
   STORE .F. TO WFLAGSALTO
   DO SALTO
   IF WFLAGSALTO
      STORE 1 TO WLINEA
      @ WLINEA,40-(LEN(RTRIM(QNOMBRE))/2) SAY QNOMBRE
      @ WLINEA,70                         SAY "Pag."+ALLTRIM(STR(WPAGINA,3))
      STORE WLINEA + 1 TO WLINEA
      @ WLINEA,00                         SAY REPLICATE("-",80)
      STORE WLINEA + 1 TO WLINEA
   ENDIF
   @ WLINEA,02 SAY ". "+QDESREN
   @ WLINEA,02 SAY ". "+QDESREN
ENDIF
RETURN
************
PROC HISDDET
************
STORE SUBSTR(QCODDAT,9,3) TO QCODTAB
*** IMPRIME TITULO DEL TABULADOR SI LO HAY
IF QCODTAB<>SPACE(3)
   SELECT HISTAB
   SEEK QCODDAT
   IF FOUND()
      STORE DESTAB     TO QDESTAB
      STORE UNDTAB     TO QUNDDAT
      STORE VALNOR     TO QVALNOR
      STORE WLINEA + 1 TO WLINEA
      STORE .F. TO WFLAGSALTO
      DO SALTO
      IF WFLAGSALTO
         STORE 1 TO WLINEA
         @ WLINEA,40-(LEN(RTRIM(QNOMBRE))/2) SAY QNOMBRE
         @ WLINEA,70                         SAY "Pag."+ALLTRIM(STR(WPAGINA,3))
         STORE WLINEA + 1 TO WLINEA
         @ WLINEA,00                            SAY REPLICATE("-",80)
         STORE WLINEA + 1 TO WLINEA
      ENDIF
      @ WLINEA,06 SAY QDESTAB
      @ WLINEA,06 SAY QDESTAB
   ENDIF
ENDIF
*** IMPRIME RENGLONES QUE CORESPONDAN CON EL FILTRO DE DATA 
*** INCLUYENDO LOS YA DESECHADOS DEL MISMO SUBGRUPO Y TAB
STORE .T. TO WFLAGSKIP
STORE HISGEN.CODPAC+HISGEN.CODACT+STR(HISGEN.NUMACT,4)+QCODDAT TO WCLAVEDAT
SELECT HISDET
SEEK WCLAVEDAT
DO WHILE .NOT. EOF() .AND. (CODPAC+CODACT+STR(NUMACT,4))=WCLAVEDET .AND. CODDAT=QCODDAT
   STORE WLINEA + 1 TO WLINEA
   IF SUBSTR(HISDET.DATREN,1,1)<>"*"
      IF WFORMATO=1
         @ WLINEA,06 SAY HISDET.DATREN
      ELSE
         IF WFLAGSKIP
            STORE WLINEA-1 TO WLINEA
            STORE .F. TO WFLAGSKIP
         ENDIF
         @ WLINEA,35 SAY ALLTRIM(HISDET.DATREN)+" "+ALLTRIM(QUNDDAT)
         @ WLINEA,79-LEN(ALLTRIM(QVALNOR)) SAY ALLTRIM(QVALNOR)
      ENDIF
   ELSE
      STORE WLINEA - 1 TO WLINEA
   ENDIF
   STORE .F. TO WFLAGSALTO
   DO SALTO
   IF WFLAGSALTO
      STORE 1 TO WLINEA
      @ WLINEA,40-(LEN(RTRIM(QNOMBRE))/2) SAY QNOMBRE
      @ WLINEA,70                         SAY "Pag."+ALLTRIM(STR(WPAGINA,3))
      STORE WLINEA + 1 TO WLINEA
      @ WLINEA,00                            SAY REPLICATE("-",80)
      STORE WLINEA + 1 TO WLINEA
   ENDIF
   SELECT HISDET
   SKIP
ENDDO
*** PARA QUE REGRESE AL REGISTRO QUE NO CUMPLIO CON EL FILTRO
*** Y SEA PROCESADO EN EL PROXIMO DISPLAY
IF .NOT. EOF()
   SKIP -1
ENDIF
RETURN
************
PROC SALIDA
************
GO BOTT
RETURN

