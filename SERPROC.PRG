PROCEDURE INDICES
DEFI WIND WININD FROM 05,55 TO 07,79 ;
                 TITLE " REORGANIZAR " ;
                 DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
ACTI WIND WININD
@ 0,0 CLEAR
store 2 to wop
do while .t.
   store space(10) to wclaveind
   @ 00,01  say "Clave:" get wclaveind
   read
   if UPPER(wclaveind)<>"EJCM      "
      exit
   endif
   @ 00,00
   @ 00,01  get wop pict "@*H Aceptar ;Cancelar" defa wop
   read
   if lastkey()=13
      exit
   endif
enddo
if wop=1
   @ 00,00
   @ 00,02 SAY "Favor esperar..."
else
   RELE WIND WININD
   RETURN
endif
***
CLOSE DATA
CLOSE INDEX
SELECT 1
USE SERDCGE
IF FILLOC()
   INDEX ON NUMERO           TO SERDCGE
   INDEX ON REFERENCIA       TO SERDCGE2
   INDEX ON PROVEEDOR+NUMERO TO SERDCGE3
   INDEX ON CUENTA           TO SERDCGE4
   INDEX ON FACTURA          TO SERDCGE5
   UNLOCK ALL
ELSE
   STORE "OPERACION RECHAZADA, REINTENTE" TO WTEXT
   DO AVISO WITH MES
ENDIF
***
SELECT 1
USE SERDCDE
IF FILLOC()
   INDEX ON NUMERO+RENGLON TO SERDCDE
   UNLOCK ALL
ELSE
   STORE "OPERACION RECHAZADA, REINTENTE" TO WTEXT
   DO AVISO WITH MES
ENDIF
***
RELE WIND WININD
STORE "EL SISTEMA SE REINICIARA, OPRIMA <ENTER> PARA CONTINUAR." TO MES
DO AVISO WITH MES
CLOSE DATA
CLOSE INDEX
SET PROC TO SYSPROC
RETURN TO MASTER
*****************
PROCEDURE COMPACTA
DEFI WIND WINCOM FROM 00,00 TO 24,79 ;
                 TITLE " COMPACTAR " ;
                 DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
ACTI WIND WINCOM
@ 0,0 CLEAR
store 2 to wop
do while .t.
   store space(10) to wclaveind
   @ 12,35  say "Clave:" get wclaveind
   read
   if UPPER(wclaveind)<>"EJCM      "
      exit
   endif
   @ 14,35  get wop pict "@*H Aceptar ;Cancelar" defa wop
   read
   if lastkey()=13
      exit
   endif
enddo
if wop=1
   @ 16,35 SAY "Favor esperar..."
else
   RELE WIND WINCOM
   RETURN
endif
***
SELECT 1
USE SERDCGE 
IF FILLOC()
   PACK
   UNLOCK ALL
ELSE
   STORE "OPERACION RECHAZADA, REINTENTE" TO WTEXT
   DO AVISO WITH MES
ENDIF
***
SELECT 2
USE SERDCDE
IF FILLOC()
   PACK
   UNLOCK ALL
ELSE
   STORE "OPERACION RECHAZADA, REINTENTE" TO WTEXT
   DO AVISO WITH MES
ENDIF
***
RELE WIND WINCOM
STORE "EL SISTEMA SE REINICIARA, OPRIMA <ENTER> PARA CONTINUAR." TO WTEXT
DO AVISO WITH MES
CLOSE DATA
CLOSE INDEX
SET PROC TO SYSPROC
RETURN TO MASTER
*****************
PROCEDURE VACIA
IF WUSERCODE <> "EDUARDO"
   RETURN
ELSE
   SELECT SERDATA
   IF RECLOC()
      REPLACE SERSERISOL WITH 0
      REPLACE SERSERICOM WITH 0
      FLUSH
      UNLOCK ALL
   ELSE
      STORE "REINTENTE" TO MES
      DO AVISO WITH MES
      RETURN
   ENDIF
   SELECT SERDCGE
   IF FILLOC()
      ZAP
      UNLOCK ALL
   ELSE
      STORE "REINTENTE" TO MES
      DO AVISO WITH MES
      RETURN
   ENDIF
   SELECT SERDCDE
   IF FILLOC()
      ZAP
      UNLOCK ALL
   ELSE
      STORE "REINTENTE" TO MES
      DO AVISO WITH MES
      RETURN
   ENDIF
   STORE "OPERACION EFECTUADA SATISFACTORIAMENTE" TO MES
   DO AVISO WITH MES
   RETURN
ENDIF
*************
PROCEDURE RECLOC
DEFI WIND WINRLOCK FROM 12,05 TO 18,75 DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
STORE .F. TO WFLAGRL
STORE .F. TO WRECMES
STORE .T. TO WRECLOC
DO WHILE WRECLOC
   IF RLOCK()
      STORE .T. TO WFLAGRL
      EXIT
   ELSE
      IF .NOT. WRECMES
         ACTI WIND WINRLOCK
         @ 02,15 SAY "REGISTRO OCUPADO POR OTRO USUARIO, REINTENTANDO ..."
         @ 03,15 SAY "          OPRIMA [ESC] PARA ABANDONAR              "
         STORE .T. TO WRECMES
      ENDIF
      WVALUE = INKEY()
      IF WVALUE = 27
         EXIT
      ENDIF
   ENDIF
ENDDO
RELEASE WIND WINRLOCK
RETURN WFLAGRL
******************************************************************************
PROCEDURE FILLOC
DEFI WIND WINFLOCK FROM 12,05 TO 18,75 DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
STORE .F. TO WFLAGFL
STORE .F. TO WFILMES
STORE .T. TO WFILLOC
DO WHILE WFILLOC
   IF FLOCK()
      STORE .T. TO WFLAGFL
      EXIT
   ELSE
      IF .NOT. WFILMES
         ACTI WIND WINFLOCK
         @ 02,15 SAY "ARCHIVO  OCUPADO POR OTRO USUARIO, REINTENTANDO ..."
         @ 03,15 SAY "          OPRIMA [ESC] PARA ABANDONAR              "
         STORE .T. TO WFILMES
      ENDIF
      WVALUE = INKEY()
      IF WVALUE = 27
         EXIT
      ENDIF
   ENDIF
ENDDO
RELEASE WIND WINFLOCK
RETURN WFLAGFL
***********************
PROCEDURE PREGUNTA
STORE .T. TO WPREG
DO WHILE WPREG
   @ 23,0
   STORE SUBSTR(WCH,1,1) TO WCHOICE
   @ 23,40- (LEN(TEX)/2) SAY TEX GET WCHOICE
   READ
   IF LASTKEY()=27
      LOOP
   ENDIF
   IF AT(WCHOICE,WCH) > 0
      STORE .F. TO WPREG
      EXIT
   ENDIF
ENDDO
@ 23,0
STORE WCHOICE TO WCH
RETURN
*************************
 PROCEDURE MENSAJE
 PARAMETERS MES
 @ 23,1
 @ 23,40-(LEN(MES)/2) SAY MES
 RETURN
 **************************************************
 PROCEDURE AVISO
 PARAMETERS MES
 STORE " " TO X
 DEFI WIND WINAVI FROM 22,00 TO 24,79 COLOR SCHE 07
 ACTI WIND WINAVI
 @ 00,38-(LEN(MES)/2) SAY MES GET X
 READ
 DEACT WIND WINAVI
 RETURN
 *****************
 PROCEDURE CHKPRINT
 PARAMETERS SALTAR
 store .t. to wprinting
 do while wprinting
    store "Prepare la impresora y oprima (Ù) para continuar o (R)echazar" to Qmes
    @ 23,1 
    @ 23,40-(len(Qmes)/2) say Qmes
    store " " to wstat
    @ 23,78 get wstat
    read
    if upper(wstat) = "R"
       store 1 to saltar
       store .f. to wprinting
    else
       store 0 to saltar
       if sys(13) = "READY"
          store .f. to wprinting
       endif
    endif
    @ 23,1
 enddo
 RETURN
***********************
PROCEDURE ERRCON
STORE "ERROR IRRECUPERABLE No "+STR(ERROR(),5)+" , EL SISTEMA SE REINICIALIZARA. <ENTER>" TO MES
DO AVISO WITH MES
SELECT 10
USE SYSERR
IF FILLOC()
   APPEND BLANK
   REPLACE NUMERO WITH ERROR()
   REPLACE MENSAJE WITH MESSAGE()
   REPLACE PROGRAMA WITH SYS(16,4)
   REPLACE FECHA WITH WFECACT
   REPLACE HORA WITH TIME()
   FLUSH 
   UNLOCK ALL
ENDIF
CLOSE DATA
CLOSE INDEX
RETURN TO MASTER
*****************
PROCEDURE ARMACOD
STORE LEN(WCODPAC)                                    TO WLEN
STORE AT(" ",WCODPAC)                                 TO WPOS
STORE SUBSTR(WCODPAC,1,(WPOS-1))                      TO WPART1
STORE LTRIM(SUBSTR(WCODPAC,WPOS,(WLEN-WPOS)+1)) TO WPART2
STORE WPART1+"-"+WPART2                               TO WXCODPAC
RETURN
*****************
PROCEDURE ARMANOM
IF SERDCGE.TIPPAC="A"
   SELECT AFIAFI
   SET ORDER TO 1
   SEEK SERDCGE.CODPAC
   IF FOUND()
      STORE ALLTRIM(PAPELLIDO)+" "+;
            ALLTRIM(SUBSTR(SAPELLIDO,1,1))+","+;
            ALLTRIM(PNOMBRE)+" "+;
            ALLTRIM(SUBSTR(SNOMBRE,1,1))  TO WNOMBRE
      STORE HISTORIA                      TO WHISTORIA
      STORE (DATE()-NACIMIENTO)/365       TO WEDAD
      STORE DIRECCION                     TO WDIRE
   ELSE
      STORE "NO REGISTRADO"               TO WNOMBRE,WHISTORIA,WDIRE
      STORE 0                             TO WEDAD
   ENDIF
ELSE
   SELECT SYSPAC
   SEEK SERDCGE.CODPAC
   IF FOUND()
      STORE ALLTRIM(PAPELLIDO)+" "+;
            ALLTRIM(SUBSTR(SAPELLIDO,1,1))+;
            ALLTRIM(PNOMBRE)+" "+;
            ALLTRIM(SUBSTR(SNOMBRE,1,1)) TO WNOMBRE
      STORE HISTORIA                TO WHISTORIA
      STORE (DATE()-NACIMIENTO)/365 TO WEDAD
      STORE DIRECCION               TO WDIRE
   ELSE
      STORE "NO REGISTRADO" TO WNOMBRE,WHISTORIA,WDIRE
      STORE 0               TO WEDAD
   ENDIF
ENDIF
RETURN
*************************
PROCEDURE CHKACC
PARAMETERS WUSERCODE,WPROGRAMA,WACCESO,WFILTRO
SELECT SYSUSERD
STORE WUSERCODE+WPROGRAMA TO WCLAVEACC
SEEK WCLAVEACC
IF FOUND()
   STORE ACCESO TO WACCESO
   STORE FILTRO TO WFILTRO
ENDIF
RETURN
******************
PROCEDURE SYSERROR
PARAMETERS WFECHA,WUSERCODE,WERROR,WMENSAJE0,WMENSAJE1,WLINENO,WPROGRAM
CLOSE DATA
CLOSE INDEX
STORE WUSERCODE TO WUSUARIO
STORE 0 TO WCONT
USE SYSERROR
DO WHILE .T.
   IF FLOCK()
      APPEND BLANK
      REPLACE FECHA      WITH DATE()
      REPLACE USUARIO    WITH WUSUARIO
      REPLACE ERROR      WITH WERROR
      REPLACE MENSAJE    WITH WMENSAJE0
      REPLACE TEXTO      WITH WMENSAJE1
      REPLACE LINEA      WITH WLINENO
      REPLACE PROGRAMA   WITH WPROGRAM
      FLUSH
      UNLOCK ALL
      EXIT
   ELSE
      STORE WCONT+1 TO WCONT
   ENDIF
   IF WCONT>300
      EXIT
   ENDIF
ENDDO
UNLOCK ALL
CLOSE DATA
CLOSE INDEX
DEACT WIND ALL
RELEASE ALL
CLEAR ALL
RETURN TO MASTER
*****************
