*** ALMACEN TRANSACCIONES DE LOTES
SELECT ALMLOT
*** TRANSFERENCIA DE ALMTRA
STORE WUSERUBI  TO WLOTE
*STORE "FAR"    TO WLOTE
STORE WUNIDADES TO WUNID
STORE WCODIGO+WLOTE TO WCLAVE
IF WOPE = "EN" .OR. WOPE = "AE" .OR. WOPE = "DS"
   SEEK WCLAVE
   IF EOF() .AND. FILLOC()
      APPEND BLANK
      REPLACE CODART WITH WCODIGO
      REPLACE CODLOT WITH WLOTE
      REPLACE FECHAING WITH WFECHAOP
      REPLACE FECHAING WITH WFECHAOP
   ENDIF
   REPLACE UNIDADES WITH UNIDADES+WUNID
   UNLOCK ALL

   SELECT ALMLOTTR
   IF FILLOC()
      APPEND BLANK
      REPLACE CODART WITH WCODIGO
      REPLACE CODLOT WITH WLOTE
      REPLACE OPERACION WITH "EN"
      REPLACE UNIDADES WITH WUNID
      REPLACE REFERENCIA WITH WRESPALDO
      UNLOCK ALL
   ENDIF
   FLUSH
ENDIF
IF WOPE = "SA" .OR. WOPE = "AS" .OR. WOPE = "DE"
   SELECT ALMLOT
   SEEK WCLAVE
   IF EOF()
      SAVE SCRE TO S5
      STORE "CODIGO DE SUBALMACEN NO REGISTRADO" TO MES
      DO AVISO WITH MES
      STORE LINE TO WSAFE
      DO ALMLOT
      RESTORE SCRE FROM S5
      STORE WSAFE TO LINE
      RETURN
   ENDIF
   IF WUNID>UNIDADES
      STORE "ADVERTENCIA: ESTA DESCONTANDO MAS UNIDADES DE LAS QUE QUEDAN EN SUBALMACEN" TO MES
      DO AVISO WITH MES
      RETURN
   ENDIF
   IF RECLOC()
      REPLACE UNIDADES WITH UNIDADES-WUNID
      UNLOCK ALL
   ENDIF
   SELECT ALMLOTTR
   IF FILLOC()
      APPEND BLANK
      REPLACE CODART WITH WCODIGO
      REPLACE CODLOT WITH WLOTE
      REPLACE OPERACION WITH "SA"
      REPLACE UNIDADES WITH WUNID
      REPLACE REFERENCIA WITH WRESPALDO
      UNLOCK ALL
   ENDIF
   SELECT ALMLOT
   FLUSH
ENDIF
SELECT ALMLOT
RETURN

