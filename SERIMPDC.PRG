SELECT SERDCGE
SEEK M.NUMERO
IF .NOT. FOUND()
   STORE "NUMERO DE DOCUMENTO :"+M.NUMERO+" NO REGISTRADO, VERIFIQUE" TO WTEXT
   DO AVISO WITH WTEXT
   RETURN
ENDIF
STORE 0   TO WPAGINA
STORE 0   TO WTOTREN
STORE 0   TO WTOTPRE
STORE 100 TO WLINEA
IF WSALIDA = 1
   DEFI WIND WINDSAL FROM 0,0 TO 25,81;
          NONE NOFLOAT NOZOOM NOGROW NOSHADOW COLOR SCHEME 10
   ACTI WIND WINDSAL
   STORE 21 TO WSALTO
ELSE
   SET DEVI TO PRINT
   STORE 60 TO WSALTO
ENDIF

STORE "**"       TO WRUPTIP
STORE "**-**"    TO WRUPESP
STORE "**-**-**" TO WRUPGRU
STORE .T.        TO WFLAGMDCO
SELECT SERDCDE
SEEK M.NUMERO
DO WHILE .NOT.EOF().AND.NUMERO=M.NUMERO
   STORE SUBSTR(ITEM,1,2) TO WTIP
   STORE SUBSTR(ITEM,1,5) TO WESP
   STORE SUBSTR(ITEM,1,8) TO WGRU
   DO RUPTURA
   ***
   IF SERDCDE.TIPITEM="B"
      SELECT ALMART
      SEEK SERDCDE.ITEM
   ELSE
      SELECT SYSSERVI
      SEEK ALLTRIM(SERDCDE.ITEM)
   ENDIF
   IF FOUND()
      STORE  DESCRI TO WNOMITEM
   ELSE
      STORE SERDCDE.ITEM+" NO REGISTRADO" TO WNOMITEM
   ENDIF
   STORE WLINEA+1 TO WLINEA
   DO VERSALTO
   SELECT SERDCDE
   IF WSALIDA=1
      @ WLINEA,00 SAY SUBSTR(WNOMITEM,1,40)
   ELSE
      @ WLINEA,00 SAY CHR(18)+CHR(15)+"* "+WNOMITEM+CHR(18)
      @ WLINEA,00 SAY CHR(18)+CHR(15)+"* "+WNOMITEM+CHR(18)
   ENDIF
   @ WLINEA,41 SAY CANTIDAD   PICTURE "9999.99"
   @ WLINEA,49 SAY PRECIO     PICTURE "9999999.99"
   @ WLINEA,61 SAY DESCUENTO  PICTURE "999.99"
   STORE CANTIDAD*(PRECIO-(PRECIO*DESCUENTO/100)) TO WTOTREN
   @ WLINEA,66 SAY WTOTREN    PICTURE "99,999,999.99"
   *STORE WTOTPRE+WTOTREN TO WTOTPRE
   SELECT SERDCDE
   SKIP
ENDDO
STORE WLINEA+1 TO WLINEA
DO VERSALTO
@ WLINEA,00 SAY REPLICATE("-",79)

STORE WLINEA+1 TO WLINEA
DO VERSALTO
@ WLINEA,36 SAY "SUBTOTAL DOCUMENTO:"
@ WLINEA,36 SAY "SUBTOTAL DOCUMENTO:"
@ WLINEA,66 SAY SERDCGE.SUBDOC PICTURE "99,999,999.99"
STORE WLINEA+1 TO WLINEA
DO VERSALTO
@ WLINEA,36 SAY "TOTAL IMPUESTOS   :"
@ WLINEA,36 SAY "TOTAL IMPUESTOS   :"
@ WLINEA,66 SAY SERDCGE.SUBIMP PICTURE "99,999,999.99"
STORE WLINEA+1 TO WLINEA
DO VERSALTO
@ WLINEA,36 SAY "TOTAL DOCUMENTO   :"
@ WLINEA,36 SAY "TOTAL DOCUMENTO   :"
@ WLINEA,66 SAY SERDCGE.MONTO  PICTURE "99,999,999.99"

IF WSALIDA=1
   STORE "OPRIMA ENTER PARA FINALIZAR" TO WTEXT
   DO AVISO WITH WTEXT
   RELE WIND WINDSAL
ELSE
   EJECT
   SET DEVI TO SCRE
ENDIF
*** COPIA EL MONTO IMPRESO AL CAMPO QUE LO ENVIA A GRABAR.
STORE WTOTPRE TO WSUBDOC
RETURN
************************************************************************
*************
PROC VERSALTO
*************
IF WLINEA>WSALTO
   IF WSALIDA=1.AND.WPAGINA>0
      STORE "OPRIMA ENTER PARA CONTINUAR" TO WTEXT
      DO AVISO WITH WTEXT
   ENDIF
   DO HEADING
ENDIF
RETURN
*************
PROC HEADING
************
STORE WPAGINA+1 TO WPAGINA
IF WSALIDA = 1
   @ 00,00 CLEAR
   @ 00,00 SAY QQWW
   @ 00,55 SAY WNOMDOC
   @ 01,00 SAY WDIRECC1
   @ 01,55 SAY "Numero      :"+SUBSTR(SERDCGE.NUMERO,4,7)
   @ 02,00 SAY WDIRECC2
   @ 02,55 SAY "Fecha       :"+DTOC(SERDCGE.ELABORADO)
   @ 03,00 SAY WDIRECC3
   @ 03,55 SAY "Pagina      :"+ALLTRIM(STR(WPAGINA,3))
   @ 04,00 SAY "R.I.F.: "+ WRIF+" N.I.T.: "+WNIT
ELSE
   @ 00,00 SAY CHR(18)+CHR(14)+QQWW
   @ 01,00 SAY CHR(18)+CHR(15)+WDIRECC1
   @ 01,55 SAY CHR(18)
   @ 01,55 SAY WNOMDOC 
   @ 02,00 SAY CHR(15)+WDIRECC2
   @ 02,55 SAY CHR(18)
   @ 02,55 SAY "Numero    :"+SUBSTR(SERDCGE.NUMERO,4,7)
   @ 03,00 SAY CHR(15)+WDIRECC3
   @ 03,55 SAY CHR(18)
   @ 03,55 SAY "Fecha     :"+DTOC(SERDCGE.ELABORADO)
   @ 04,00 SAY CHR(15)+"R.I.F.: "+ WRIF+" N.I.T.: "+WNIT
   @ 04,55 SAY CHR(18)
   @ 04,55 SAY "Pagina    :"+ALLTRIM(STR(WPAGINA,3))
   @ 05,55 SAY "Referencia:"+SERDCGE.REFERENCIA   
ENDIF
STORE SERDCGE.TIPPAC    TO M.TIPPAC
STORE SERDCGE.CODPAC    TO M.CODPAC
STORE SPACE(30)         TO WNOMPAC
DO VALPAC
STORE SERDCGE.ORDENADO  TO M.ORDENADO
STORE SERDCGE.PROVEEDOR TO M.PROVEEDOR
STORE SPACE(30)         TO WNOMORD
STORE SPACE(30)         TO WNOMPRO  
DO VALORD
DO VALPRO
@ 07,00 SAY "Solicitante: "+M.ORDENADO +"  "+WNOMORD
@ 08,00 SAY "Ejecutor   : "+M.PROVEEDOR+"  "+WNOMPRO
@ 09,00 SAY "Paciente   : "+ALLTRIM(SUBSTR(SERDCGE.CODPAC,1,10))+"-"+ALLTRIM(SUBSTR(SERDCGE.CODPAC,11,4))+" "+WNOMPAC

@ 11,00 SAY replicate("-",79)
@ 11,00 SAY replicate("-",79)
@ 12,00 say "Descripcion"
@ 12,00 say "Descripcion"
@ 12,41 say " Cantd."
@ 12,41 say " Cantd."
@ 12,49 say "    Precio"
@ 12,49 say "    Precio"
@ 12,60 say "%Desc."
@ 12,60 say "%Desc."
@ 12,66 say "  Total Reng."
@ 12,66 say "  Total Reng."
@ 13,00 SAY replicate("-",79)
@ 13,00 SAY replicate("-",79)
STORE 14 TO WLINEA
RETURN
************
PROC RUPTURA
************
IF WTIP<>WRUPTIP.OR.WESP<>WRUPESP.OR.WGRU<>WRUPGRU
   IF SERDCDE.TIPITEM="S"
      IF WTIP<>WRUPTIP
         SELECT SYSSERVI
         SEEK WTIP+"-  -  -   "
         IF FOUND()
            STORE DESCRI     TO WNOMTIP
         ELSE
            STORE SPACE(1)   TO WNOMTIP
         ENDIF
         IF WNOMTIP<>SPACE(1)
            STORE WLINEA+1 TO WLINEA
            DO VERSALTO
            @ WLINEA,40-LEN(ALLTRIM(WNOMTIP))/2 SAY ALLTRIM(WNOMTIP)
            @ WLINEA,40-LEN(ALLTRIM(WNOMTIP))/2 SAY ALLTRIM(WNOMTIP)
         ENDIF
         STORE WTIP       TO WRUPTIP
         STORE "**-**"    TO WRUPESP
         STORE "**-**-**" TO WRUPGRU
      ENDIF
      IF WESP<>WRUPESP
         SELECT SYSSERVI
         SEEK WESP+"-  -   "
         IF FOUND()
            STORE DESCRI TO WNOMESP
         ELSE
            STORE "****" TO WNOMESP
         ENDIF
         IF WNOMESP<>SPACE(1)
            STORE WLINEA+1 TO WLINEA
            DO VERSALTO
            @ WLINEA,00 SAY CHR(15)+WNOMESP+CHR(18)
         ENDIF
         STORE WESP       TO WRUPESP
         STORE "**-**-**" TO WRUPGRU
      ENDIF
      IF WGRU<>WRUPGRU
         SELECT SYSSERVI
         SEEK WGRU+"-   "
         IF FOUND()
            STORE DESCRI TO WNOMGRU
         ELSE
            STORE SPACE(1)    TO WNOMGRU
         ENDIF
         IF WNOMGRU<>SPACE(1)
            STORE WLINEA+1 TO WLINEA
            DO VERSALTO
            @ WLINEA,00 SAY CHR(15)+WNOMGRU+CHR(18)
         ENDIF
         STORE WGRU TO WRUPGRU
      ENDIF
   ELSE
      IF WFLAGMDCO
         STORE WLINEA+1 TO WLINEA
         DO VERSALTO
         @ WLINEA,25 SAY  "Medicamentos y Material medico"
         @ WLINEA,25 SAY  "Medicamentos y Material medico"
         *STORE WLINEA+1 TO WLINEA
         *DO VERSALTO
         *@ WLINEA,25 SAY "------------------------------"
         STORE .F. TO WFLAGMDCO
      ENDIF
   ENDIF
ENDIF
RETURN
****************
PROCEDURE VALPAC
****************
IF M.TIPPAC="A"
   SELECT AFIAFI
   SET ORDER TO AFIAFI1
   SEEK M.CODPAC
   IF .NOT. FOUND()
      STORE "PACIENTE NO AFILIADO" TO WNOMPAC
   ELSE
      STORE ALLTRIM(PAPELLIDO)+", "+ALLTRIM(PNOMBRE) TO WNOMPAC
   ENDIF
ELSE
   SELECT SYSPAC
   SEEK M.CODPAC
   IF .NOT. FOUND()
      STORE "PACIENTE NO REGISTRADO" TO WNOMPAC
   ELSE
      STORE ALLTRIM(PAPELLIDO)+", "+ALLTRIM(PNOMBRE) TO WNOMPAC
   ENDIF
ENDIF
RETURN
****************
PROCEDURE VALORD
****************
SELECT SYSPTO
SEEK M.ORDENADO
IF FOUND()
   STORE ALLTRIM(DESCRI) TO WNOMORD
ENDIF
RETURN
****************
PROCEDURE VALPRO
****************
SELECT SYSPTO
SEEK M.PROVEEDOR
IF FOUND()
   STORE ALLTRIM(DESCRI) TO WNOMPRO
ENDIF
RETURN




