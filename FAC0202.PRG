UNLOCK ALL
PUSH KEY CLEAR
DEFI WIND WINDGE FROM 1,0 TO 19,79;
          TITLE  " FACTURAS " ;
          FOOTER " F1=Inc, F2=Mod, F3=Anu, F4=Bus, F5=Ord, F6=Ver, Esc=Salir " ;
          DOUBLE NOFLOAT NOZOOM NOGROW COLOR SCHEME 10


DEFI WIND WINDTT FROM 20,0 TO 22,79;
          DOUBLE NOFLOAT NOZOOM NOGROW COLOR SCHEME 10
ON KEY LABEL F1 DO PROGEINC
ON KEY LABEL F2 DO PROGEMOD
ON KEY LABEL F3 DO PROGEELI
ON KEY LABEL F4 DO PROGEBUS
ON KEY LABEL F5 DO PROGEORD
ON KEY LABEL F6 DO PROGEVER
*
STORE .F.      TO WFLAGPRINT
STORE SPACE(1) TO WNOMPAC   
*
SELECT FACDCGE
GO BOTT
ACTI WIND WINDGE
BROWSE FIELDS WFUNNUM=FUNNUM():H="NUMERO",;
              REFERENCIA:H="REFERENCIA",;
              ELABORADO:H="FECHA",;
              AREA:H="AREA",;
              MONTO:H="MONTO",;
              XNOMPAC=FUNNOM():H="PACIENTE                      ",;
              USUARIO:H="CAJERO";
       NOAPPEND NODELETE NOEDIT NOMENU NOOPTIMIZE REST SAVE IN WINDOW WINDGE 
DEACT WIND WINDGE
DEACT WIND WINDDE
DEACT WIND WINDTT
POP KEY
RETURN
***********
FUNC FUNNUM
***********
PUSH KEY CLEAR
STORE FACDCGE.NUMERO TO WFUNNUM
POP KEY
RETURN WFUNNUM
************
FUNC FUNNOM
************
PUSH KEY CLEAR
STORE SPACE(1) TO XNOMPAC
STORE TIPPAC   TO XTIPPAC
STORE CODPAC   TO XCODPAC
DO BUSPACX
STORE XNOMPAC  TO XNOMPAC
SELECT FACDCGE
POP KEY
RETURN XNOMPAC
******************
PROCEDURE PROGEINC
******************
PUSH KEY CLEAR
SELECT FACDCGE
SET ORDER TO FACDCGE
STORE "INCLUIR"             TO WFLAGACT
SCATT MEMV BLANK
* 
STORE "FAC"                 TO WTIPODOC
STORE WUSERCODE             TO M.NUMERO 
STORE "*"+SPACE(14)         TO M.CODCLI  
STORE SPACE(1)              TO M.DESCRI
STORE SPACE(1)              TO M.TIPPAC 
STORE SPACE(14)             TO M.CODPAC
STORE SPACE(1)              TO M.NOMPAC 
STORE FACDATA.IMPUESTO      TO M.PORIMP
STORE DATE()                TO M.ELABORADO
STORE 0                     TO WMONTODOC
STORE .T.                   TO WFLAGING  
STORE .T.                   TO WFLAGEDIT
DO LIMFAC
DO GETGEN
IF WFLAGEDIT
   STORE "GUARDAR FACTURA" TO WFLAGR
   STORE 1 TO WOP
   DO PROCOPC WITH WFLAGR
   IF WOP=1
      STORE 0 TO M.NUMERON
      STORE 0 TO WSERIAREA 
      DO CREANUM
      DO CONVNUM
      DO ASIGNUM
      DO ACTUNUM
      DO ASIGSERI
      DO PROGEVER
      DO FACACTCC
      DO FACACTIN
   ELSE
      DO LIMFAC
   ENDIF
ELSE
   DO LIMFAC
ENDIF
POP KEY
SELECT FACDCGE
UNLOCK ALL
RETURN
******************
PROCEDURE PROGEMOD
******************
IF WUSERCODE<>"EDUARDO "
   IF WUSERCODE<>FACDCGE.USUARIO
      STORE "FACTURA PERTENECE AL USUARIO "+FACDCGE.USUARIO TO WTEXT
      DO AVISO WITH WTEXT
      RETURN
   ENDIF
   IF FACDCGE.SUBDOC=0
      RETURN
   ENDIF
ENDIF
PUSH KEY CLEAR
SELECT FACDCGE
SET ORDER TO FACDCGE
STORE "MODIFICAR" TO WFLAGACT
STORE SPACE(1)    TO M.NOMPAC
SCATT MEMV
STORE .T.         TO WFLAGEDIT   
DO GETGEN
DO FACACTCC
DO FACACTIN
POP KEY
SELECT FACDCGE
UNLOCK ALL
RETURN
******************
PROCEDURE PROGEELI
******************
IF WUSERCODE<>"EDUARDO "
   IF (WACCESO<>"A").AND.(WUSERCODE<>FACDCGE.USUARIO .OR. DATE()<>FACDCGE.ELABORADO)
      STORE "NO ESTA AUTORIZADO PARA ANULAR ESTA FACTURA" TO WTEXT
      DO AVISO WITH WTEXT
      RETURN
   ENDIF
ENDIF
PUSH KEY CLEAR
SELECT FACDCGE
SET ORDER TO FACDCGE
STORE "ANULAR" TO WFLAGACT
STORE 1 TO WOP
DO PROCOPC2 WITH WFLAGACT
IF WOP=2
   ********************
   STORE .T. TO WFLAGREF
   IF SUBSTR(FACDCGE.REFERENCIA,1,3)="SOL"
      SELECT SERDCGE
      SEEK FACDCGE.REFERENCIA
      IF FOUND()
         IF COMPROB=SPACE(10)
            IF RECLOC()
               REPLACE FACTURA WITH SPACE(10)
               FLUSH
               UNLOCK ALL
            ELSE
               STORE "OPERACION RECHAZADA: "+FACDCGE.REFERENCIA+" NO FUE ACTUALIZADA, REINTENTE." TO WTEXT
               DO AVISO WITH WTEXT
               STORE .F. TO WFLAGREF
            ENDIF
         ELSE
            STORE "OPERACION RECHAZADA: "+FACDCGE.REFERENCIA+" PROCESADA CON "+COMPROB+" REINTENTE." TO WTEXT
            DO AVISO WITH WTEXT
            STORE .F. TO WFLAGREF
         ENDIF
      ELSE
         STORE "SOLICITUD :"+FACDCGE.REFERENCIA+" NO REGISTRADA, REINTENTE." TO WTEXT
         DO AVISO WITH WTEXT
         STORE .F. TO WFLAGREF
      ENDIF
   ELSE
      IF SUBSTR(FACDCGE.REFERENCIA,1,3)="CTA"
         SELECT ADMADM
         SET ORDER TO ADMADM1
         SEEK FACDCGE.REFERENCIA
         IF FOUND()
            IF RECLOC()
               REPLACE FACTURA WITH SPACE(10)
               FLUSH
               UNLOCK ALL
            ELSE
               STORE "OPERACION RECHAZADA: "+FACDCGE.REFERENCIA+" NO FUE ACTUALIZADA, REINTENTE." TO WTEXT
               DO AVISO WITH WTEXT
               STORE .F. TO WFLAGREF
            ENDIF
         ELSE
            STORE "CUENTA :"+FACDCGE.REFERENCIA+" NO REGISTRADA, REINTENTE." TO WTEXT
            DO AVISO WITH WTEXT
            STORE .F. TO WFLAGREF
         ENDIF
      ENDIF
   ENDIF
   IF .NOT. WFLAGREF
      SELECT FACDCGE
      POP KEY
      RETURN
   ENDIF
   ******************
   SELECT FACDCGE
   IF RECLOC()
      *DELETE
      REPLACE SUBDOC   WITH 0
      REPLACE PORIMP   WITH 0
      REPLACE SUBIMP   WITH 0
      REPLACE MONTO    WITH 0
      REPLACE REFERENCIA WITH SPACE(10)
      REPLACE USUARIO  WITH WUSERCODE
      REPLACE USUARIOF WITH DATE()
      FLUSH
      UNLOCK ALL
      SELECT FACDCDE
      SEEK FACDCGE.NUMERO 
      DO WHILE .NOT.EOF().AND.FACDCGE.NUMERO=FACDCDE.NUMERO
         IF RECLOC()
            REPLACE CANTIDAD WITH 0
            FLUSH
            UNLOCK ALL
         ELSE
            DO PROCNUL
         ENDIF
         SKIP
      ENDDO
      FLUSH
      UNLOCK ALL
   ELSE
      DO PROCNUL
   ENDIF
ENDIF
DO FACACTCC
DO FACACTIN
SELECT FACDCGE
POP KEY
RETURN
*******************
*PROCEDURE PROGEBUS
*******************
*PUSH KEY CLEAR
*DEFI WIND WINDBUS FROM 12,12 TO 14,55;
*          TITLE " BUSCAR ";
*          DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
*ACTIVATE WIND WINDBUS
*STORE 0 TO M.NUMERON
*@ 00,03 SAY "NUMERO: " GET M.NUMERON PICTURE "9999999"
*READ
*DO CONVNUM
*SEEK "FAC"+M.NUMERON
*RELE WIND WINDBUS
*POP KEY
*RETURN


******************
PROCEDURE PROGEBUS
******************
PUSH KEY CLEAR
DEFI WIND WINDBUS FROM 12,12 TO 14,55;
          TITLE " BUSCAR ";
          DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
ACTIVATE WIND WINDBUS
STORE SPACE(14) TO WCAMPO
@ 00,03 SAY "CLAVE: " GET WCAMPO
READ
SEEK RTRIM(WCAMPO)
RELE WIND WINDBUS
POP KEY
RETURN

******************
PROCEDURE PROGEVER
******************
PUSH KEY CLEAR
SELECT FACDCGE
SET ORDER TO FACDCGE
DEFI WIND WINDVER FROM 12,19 TO 14,59;
          TITLE " SALIDA ";
          DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
ACTIVATE WIND WINDVER
DO WHILE .T.
   STORE 1 TO WOP
   @ 00,03 SAY "OPCIONES: ";
   GET WOP PICT "@*H IMPRESORA;MONITOR   "
   READ
   IF LASTKEY()=13
      EXIT
   ENDIF
ENDDO
RELE WIND WINDVER
STORE FACDCGE.NUMERO TO WNUMERO2
STORE WOP            TO WSALIDA
DO FACIMPDC
POP KEY
SELECT FACDCGE
RETURN
******************
PROCEDURE PROGEORD
******************
DEFI WIND WINDBUS FROM 12,10 TO 14,70;
          TITLE " ORDEN ";
          DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
ACTIVATE WIND WINDBUS
DO WHILE .T.
   STORE 1 TO WOP
   @ 00,03 SAY "OPCIONES: ";
   GET WOP PICT "@*H FACTURA  ;PACIENTE ;REFCIA."
   READ
   IF LASTKEY()=13
      EXIT
   ENDIF
ENDDO
RELE WIND WINDBUS
DEAC WIND WINDGE 
SET ORDER TO FACDCGE 
IF WOP=1
   SET ORDER TO FACDCGE
ENDIF
IF WOP=2
   SET ORDER TO FACDCGE4
ENDIF
IF WOP=3
   SET ORDER TO FACDCGE2
ENDIF
ACTI WIND WINDGE  
RETURN

***********
PROC LIMFAC
***********
SELECT FACDCGE
DO WHILE .T.
   SEEK M.NUMERO
   IF FOUND()
      IF RECLOC()
         DELETE 
         UNLOCK ALL
      ENDIF
   ELSE
      EXIT
   ENDIF
ENDDO
SELECT FACDCDE
SET ORDER TO FACDCDE
DO WHILE .T.
   SEEK M.NUMERO
   IF FOUND()
      IF RECLOC()
         DELETE
         UNLOCK ALL
      ENDIF
   ELSE
      EXIT
   ENDIF
ENDDO
SELECT SERDCGE
SEEK M.REFERENCIA
IF FOUND()
   IF RECLOC()
      REPLACE FACTURA WITH SPACE(10)
      FLUSH
      UNLOCK ALL
   ENDIF
ENDIF
RETURN
************
PROC CREANUM
************
* CREA SERIAL DE FACTURACION
SELECT FACDATA
IF RECLOC()
   STORE FACSERIFAC+1   TO   M.NUMERON
ENDIF
RETURN
************
PROC CONVNUM
************
* CONVIERTE SERIAL NUMERICO A CARACTER
STORE LTRIM(STR(M.NUMERON,7))                   TO M.NUMERON
STORE REPLICATE("0",7-LEN(M.NUMERON))+M.NUMERON TO M.NUMERON
RETURN
************
PROC ASIGNUM
************
* ASIGNA EL SERIAL A LA PRE-FACTURA (NUMERO=WUSERCODE)
STORE "FAC"+M.NUMERON TO WNUMFAC
SELECT FACDCGE
DO WHILE .T.
   SEEK M.NUMERO
   IF FOUND()
      IF RECLOC()
         REPLACE NUMERO     WITH WNUMFAC 
         FLUSH
         UNLOCK ALL
         EXIT
      ELSE
         STORE "ACTUALIZACION RECHAZADA, FAVOR EDITAR NUEVAMENTE" TO WTEXT
         DO AVISO WITH WTEXT
      ENDIF
   ENDIF
ENDDO
SEEK WNUMFAC
IF .NOT.FOUND()
   STORE "SE PERDIO EL REGISTRO DE LA FACTURA: "+WNUMFAC TO WTEXT
   DO AVISO WITH WTEXT
ENDIF
SELECT FACDCDE
DO WHILE .T.
   SEEK M.NUMERO
   IF FOUND()
      IF RECLOC()
         REPLACE NUMERO WITH WNUMFAC
         FLUSH
         UNLOCK ALL
      ELSE
         STORE "ACTUALIZACION RECHAZADA, FAVOR EDITAR NUEVAMENTE" TO WTEXT
         DO AVISO WITH WTEXT
      ENDIF
   ELSE
      EXIT
   ENDIF
ENDDO
SELECT SERDCGE
SEEK M.REFERENCIA
IF FOUND()
   IF RECLOC()
      REPLACE FACTURA WITH WNUMFAC
      FLUSH
      UNLOCK ALL
   ENDIF
ENDIF
STORE WNUMFAC TO M.NUMERO
RETURN
************
PROC ACTUNUM
************
* ACTUALIZA TABLA DE SERIAL DE FACTURACION
SELECT FACDATA
IF RECLOC()
   REPLACE FACSERIFAC WITH FACSERIFAC+1
   FLUSH
   UNLOCK ALL
ENDIF
RETURN
*************
PROC ASIGSERI
*************
SELECT FACDCDE
SEEK M.NUMERO
IF FOUND()
   STORE AREA TO WARSER
   SELECT SYSPTO
   SEEK WARSER
   IF FOUND()
      IF RECLOC()
         REPLACE SERIAL WITH SERIAL + 1
         FLUSH
         UNLOCK ALL
         STORE SERIAL TO WSERIAREA
      ENDIF
   ENDIF
ENDIF
SELECT FACDCGE
SEEK M.NUMERO
IF FOUND()
   IF RECLOC()
      REPLACE SERIALESPE WITH WSERIAREA
      FLUSH
   ENDIF
ENDIF
RETURN
***********
PROC GETGEN
***********
DEFI WIND WINDGETG FROM 2,0 TO 10,79;
          TITLE  " "+WFLAGACT+" " ;
          FOOTER " Esc=Salir";
          DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
ACTI WIND WINDGETG
DO WHILE .T.
   @ 0,01 SAY "Numero  :"
   @ 2,01 SAY "Refcia  :"
   @ 4,01 SAY "Pago    :"

   @ 0,21 SAY "Cliente :"       
   @ 2,21 SAY "Paciente:"

   @ 0,58 SAY "Elaborado:"
   @ 2,58 SAY "Vence    :" 
   @ 4,58 SAY "Cancelado:"

   @ 0,10 SAY M.NUMERO
   IF WFLAGACT="MODIFICAR"
      DO BUSCLI
      DO BUSPAC
      @ 0,30 SAY SUBSTR(M.DESCLI,1,25)
      @ 2,32 SAY SUBSTR(M.NOMPAC,1,25)
      @ 0,68 SAY M.ELABORADO
      @ 2,68 SAY M.VENCE
      @ 4,68 SAY M.CANCELADO
   ENDIF
   IF WFLAGACT="INCLUIR"
      *** PETICION DE REFERENCIA Y GENERACION DE FACTURA CON ESTA
      STORE SPACE(3)        TO WTIPREF
      STORE 0               TO WNUMREF
      STORE .F.             TO WFLAGGEN
      @ 2,10 GET WTIPREF                   VALID VALTR()
      READ
      IF LASTKEY()=27
         STORE .F. TO WFLAGEDIT
         EXIT
      ENDIF
      IF WTIPREF<>SPACE(3)
         @ 2,10 SAY WTIPREF
         @ 2,13 GET WNUMREF PICTURE "9999999" VALID VALNR()
         READ
         IF .NOT. WFLAGGEN 
            STORE .F. TO WFLAGEDIT
            EXIT
         ENDIF
         @ 2,13 SAY WNUMREF PICT "9999999"    
         STORE WTIPREF+WNUMREF TO M.REFERENCIA   
      ELSE   
         STORE SPACE(7)        TO WNUMREF
         STORE WTIPREF+WNUMREF TO M.REFERENCIA   
         SELECT FACDCGE
         IF FILLOC() 
            APPEND BLANK
            REPLACE NUMERO     WITH M.NUMERO
            REPLACE REFERENCIA WITH M.REFERENCIA
            FLUSH
            UNLOCK ALL
         ELSE
            STORE "ACTUALIZACION RECHAZADA, FAVOR EDITAR NUEVAMENTE" TO WTEXT
            DO AVISO WITH WTEXT
            EXIT
         ENDIF
      ENDIF
   ELSE
      @ 2,10 SAY M.REFERENCIA
   ENDIF

   *** FORMA DE PAGO
   @ 4,10 GET M.PAGOFOR  VALID VALPAGO()
   READ
   IF LASTKEY()=27
      STORE .F. TO WFLAGEDIT
      EXIT
   ENDIF
   @ 4,12 GET M.PAGOREF 
   READ
   IF LASTKEY()=27
      STORE .F. TO WFLAGEDIT
      EXIT
   ENDIF
   
   *** CLIENTE
   @ 0,30 GET M.CODCLI  VALID VALCLI()
   READ
   @ 0,30 SAY SUBSTR(M.DESCLI,1,25)
   IF M.CODCLI=SPACE(15)
      STORE .F. TO WFLAGEDIT
      EXIT
   ENDIF

   *** PACIENTE
   STORE .F.                        TO WFLAGPAC
   STORE SUBSTR(M.CODPAC,1,10)      TO WCODPAC1
   STORE VAL(SUBSTR(M.CODPAC,11,4)) TO WCODPAC2
   STORE SPACE(1)                   TO WNIVEL
   IF SUBSTR(M.REFERENCIA,1,3)=SPACE(3)
      @ 02,30 GET M.TIPPAC                VALID VALTIPPAC()         
      READ
      IF LASTKEY()=27
         STORE .F. TO WFLAGEDIT
         EXIT
      ENDIF
      @ 02,32 GET WCODPAC1
      @ 02,42 SAY "-"
      @ 02,43 GET WCODPAC2 PICTURE "9999" VALID VALPAC()
      READ
      IF WCODPAC1=SPACE(10)
         STORE .F. TO WFLAGEDIT
         EXIT
      ENDIF
   ELSE
      DO VALPAC
   ENDIF
   IF WFLAGPAC
      @ 2,30 SAY M.TIPPAC
      @ 2,32 SAY SUBSTR(M.NOMPAC,1,25)
   ELSE
      STORE .F. TO WFLAGEDIT
      EXIT
   ENDIF

   DO VALCXC

   *** ELABORACION
   @ 0,68 SAY M.ELABORADO

   *** VENCIMIENTO
   IF M.PAGOFOR="R"
      IF WFLAGACT="INCLUIR"
         STORE M.ELABORADO+FACDATA.DIASCREDI TO M.VENCE
         STORE CTOD("  -  -    ")            TO M.CANCELADO
      ENDIF
      @ 2,68 GET M.VENCE   VALID VALVEN()
      READ
      IF LASTKEY()=27
         STORE .F. TO WFLAGEDIT
         EXIT
      ENDIF
   ELSE
      IF WFLAGACT="INCLUIR" 
         STORE M.ELABORADO TO M.VENCE
         STORE M.ELABORADO TO M.CANCELADO
      ENDIF
      @ 2,68 SAY M.VENCE
   ENDIF

   *** CANCELADO
   IF M.PAGOFOR="R"
      STORE CTOD("  -  -    ")            TO M.CANCELADO
   ELSE
      STORE M.ELABORADO TO M.CANCELADO
   ENDIF
   @ 4,68 SAY M.CANCELADO
                         
   EXIT
ENDDO

IF WFLAGEDIT
   SELECT FACDCGE
   IF RECLOC()
      REPLACE PAGOFOR   WITH M.PAGOFOR
      REPLACE PAGOREF   WITH M.PAGOREF
      REPLACE CODCLI    WITH M.CODCLI
      REPLACE DESCLI    WITH M.DESCLI
      REPLACE TIPPAC    WITH M.TIPPAC
      REPLACE CODPAC    WITH M.CODPAC
      REPLACE ELABORADO WITH M.ELABORADO
      REPLACE VENCE     WITH M.VENCE
      REPLACE CANCELADO WITH M.CANCELADO
      REPLACE ORIGEN    WITH "FAC"
      REPLACE DEPTO     WITH WUSERUBI
      REPLACE USUARIO   WITH WUSERCODE
      REPLACE USUARIOF  WITH DATE()
      FLUSH
      UNLOCK ALL
   ELSE
      STORE "ACTUALIZACION RECHAZADA, FAVOR EDITAR NUEVAMENTE" TO WTEXT
      DO AVISO WITH WTEXT
   ENDIF
   ***
   DO GETGENR
ENDIF
RELE WIND WINDGETG
RETURN
**********
FUNC VALTR
**********
DO WHILE .T.
   IF WTIPREF<>"SOL".AND.WTIPREF<>"CTA"
      defi wind wintip  from 05,10 to 09,27
      acti wind wintip
      @ 00,00 clear
      STORE 1 to wvalop
      do while .t.
         @ 00,01 get wvalop pict "@*V Ninguna     ;Cta.Ingreso ;Solicitud   "
         read
         if lastkey()=13
            exit
         endif
      enddo
      if wvalop=1
         store SPACE(3)   to WTIPREF
      else
         if wvalop=2
            store "CTA"   to WTIPREF
         else
            store "SOL"   to WTIPREF   
         endif
      endif
      rele wind wintip
   ENDIF
   EXIT
ENDDO
return .t.
**********
FUNC VALNR
**********
IF LASTKEY()=27
   RETURN .F.
ENDIF
IF WNUMREF=0
   IF WTIPREF="SOL"
      DO FACWINSO
      STORE VAL(SUBSTR(SERDCGE.NUMERO,4,7))    TO WNUMREF
   ELSE
      IF WTIPREF="CTA"
         DO FACWINAD
         STORE VAL(SUBSTR(ADMADM.CUENTA,4,7))  TO WNUMREF
      ENDIF
   ENDIF
ENDIF
STORE ALLTRIM(STR(WNUMREF,7))                  TO WNUMREF
STORE REPLICATE("0",7-LEN(WNUMREF))+WNUMREF    TO WNUMREF
STORE WTIPREF+WNUMREF                          TO M.REFERENCIA
DO FACGENDC
IF WFLAGGEN
   RETURN .T.
ELSE
   STORE 0 TO WNUMREF
   RETURN .F.
ENDIF
RETURN
************
FUNC VALPAGO
************
DO WHILE .T.
   IF M.PAGOFOR<>"C".AND.M.PAGOFOR<>"R"
      defi wind winpag  from 07,10 to 10,27
      acti wind winpag
      @ 00,00 clear
      STORE 1 to wvalop
      do while .t.
         @ 00,01 get wvalop pict "@*V Contado     ;Credito     "
         read
         if lastkey()=13
            exit
         endif
      enddo
      if wvalop=1
         store "C"        to M.PAGOFOR
      else
         store "R"        to M.PAGOFOR
      endif
      rele wind winpag
   ENDIF
   EXIT
ENDDO
return .t.
***********
FUNC VALCLI
***********
STORE .T. TO VIENDOCLI
DO WHILE VIENDOCLI
   IF M.PAGOFOR="C".AND.SUBSTR(M.CODCLI,1,1)="*"
      STORE .F. TO VIENDOCLI
      EXIT
   ENDIF
   SELECT FACCLI
   SEEK M.CODCLI
   IF FOUND()
      STORE DESCLI TO M.DESCLI
      RETURN .T.
   ELSE
      PUSH KEY CLEAR
      DO FAC0102
      POP KEY
      STORE CODCLI TO M.CODCLI
      STORE DESCLI TO M.DESCLI
      LOOP
   ENDIF
ENDDO
IF .NOT. VIENDOCLI
   STORE "*"+SPACE(14) TO M.CODCLI
   @ 0,30 GET M.DESCLI
   READ
ENDIF
RETURN .T.
***********
FUNC BUSCLI
***********
IF SUBSTR(M.CODCLI,1,1)<>"*"
   SELECT FACCLI
   SEEK M.CODCLI
   IF FOUND()
      STORE DESCLI TO M.DESCLI
   ELSE
      STORE ""     TO M.DESCLI
   ENDIF   
ENDIF
RETURN
**************
FUNC VALTIPPAC
**************
DO WHILE .T.
   IF M.TIPPAC<>"A".AND.M.TIPPAC<>"N"
      defi wind wintip  from 05,30 to 08,48
      acti wind wintip
      @ 00,00 clear
      STORE 1 to wvalop
      do while .t.
         @ 00,01 get wvalop pict "@*V No Afiliado ;Afiliado    "
         read
         if lastkey()=13
            exit
         endif
      enddo
      if wvalop=2
         store "A"      to M.TIPPAC
      else
         if wvalop=1
            store "N"   to M.TIPPAC
         endif
      endif
      rele wind wintip
   ENDIF
   EXIT
ENDDO
return .t.
****************
PROCEDURE VALPAC
****************
STORE WCODPAC1+STR(WCODPAC2,4) TO M.CODPAC 
IF M.TIPPAC="A"
   SELECT AFIAFI
   SET ORDER TO AFIAFI1
   SEEK M.CODPAC
   IF .NOT. FOUND()
      STORE "PACIENTE NO AFILIADO, VERIFIQUE" TO WTEXT
      DO AVISO WITH WTEXT
      STORE .F. TO WFLAGPAC
   ELSE
      STORE AFIAFI.CODPAC                            TO M.CODPAC
      STORE SUBSTR(M.CODPAC,1,10)                    TO WCODPAC1
      STORE VAL(SUBSTR(M.CODPAC,11,4))               TO WCODPAC2
      STORE AFIAFI.NIVEL                             TO WNIVEL 
      STORE ALLTRIM(AFIAFI.PAPELLIDO)+", "+;
            ALLTRIM(AFIAFI.PNOMBRE)                  TO M.NOMPAC
      STORE .T.                                      TO WFLAGPAC
   ENDIF
ELSE
   SELECT SYSPAC
   SEEK M.CODPAC
   IF .NOT. FOUND()
      librPAC=5
      cibrPAC=0
      do sys0103
   ENDIF
   STORE SYSPAC.CODPAC                               TO M.CODPAC
   STORE SUBSTR(M.CODPAC,1,10)                       TO WCODPAC1
   STORE VAL(SUBSTR(M.CODPAC,11,4))                  TO WCODPAC2
   STORE SYSPAC.NIVEL                                TO WNIVEL
   STORE ALLTRIM(SYSPAC.PAPELLIDO)+", "+;
         ALLTRIM(SYSPAC.PNOMBRE)                     TO M.NOMPAC 
   STORE .T.                                         TO WFLAGPAC
ENDIF
RETURN WFLAGPAC
****************
PROCEDURE BUSPAC
****************
IF M.TIPPAC="A"
   SELECT AFIAFI
   SET ORDER TO AFIAFI1
   SEEK M.CODPAC
   IF .NOT. FOUND()
      STORE "" TO M.NOMPAC
   ELSE
      STORE ALLTRIM(AFIAFI.PAPELLIDO)+", "+;
            ALLTRIM(AFIAFI.PNOMBRE)           TO M.NOMPAC
      STORE .T. TO WFLAGPAC
   ENDIF
ELSE
   SELECT SYSPAC
   SEEK M.CODPAC
   IF .NOT. FOUND()
      STORE "" TO M.NOMPAC    
   ELSE
      STORE ALLTRIM(SYSPAC.PAPELLIDO)+", "+;
            ALLTRIM(SYSPAC.PNOMBRE)           TO M.NOMPAC
      STORE .T. TO WFLAGPAC
   ENDIF
ENDIF
SELECT FACDCGE
RETURN 
*****************
PROCEDURE BUSPACX
*****************
IF XTIPPAC="A"
   SELECT AFIAFI
   SET ORDER TO AFIAFI1
   SEEK XCODPAC
   IF .NOT. FOUND()
      STORE "" TO XNOMPAC
   ELSE
      STORE ALLTRIM(AFIAFI.PAPELLIDO)+", "+;
            ALLTRIM(AFIAFI.PNOMBRE)          TO XNOMPAC
      STORE .T. TO WFLAGPAC
   ENDIF
ELSE
   SELECT SYSPAC
   SEEK XCODPAC
   IF .NOT. FOUND()
      STORE "" TO XNOMPAC    
   ELSE
      STORE ALLTRIM(SYSPAC.PAPELLIDO)+", "+;
            ALLTRIM(SYSPAC.PNOMBRE)          TO XNOMPAC
      STORE .T. TO WFLAGPAC
   ENDIF
ENDIF
SELECT FACDCGE
RETURN 
****************
PROCEDURE VALVEN
****************
IF M.VENCE<M.ELABORADO
   STORE "FECHA DE VENCIMIENTO DEBE SER MAYOR A LA DE ELABORACION" TO WTEXT
   DO AVISO WITH WTEXT
   RETURN .F.
ELSE
   RETURN .T.
ENDIF
RETURN
****************
PROCEDURE VALCXC
****************
SELECT FACCXC
SET ORDER TO FACCXC2
SEEK M.CODCLI
DO WHILE .NOT. EOF() .AND. FACCXC.CODCLI=M.CODCLI
   IF CANCELADO=CTOD("  -  -    ")
      STORE "CLIENTE CON DEUDA PENDIENTE. FAC No."+FACCXC.REFERENCIA TO WTEXT
      DO AVISO WITH WTEXT
   ENDIF
   SKIP
ENDDO
STORE SUBSTR(M.CODPAC,1,13)+SPACE(2) TO WCXCCODPAC
SEEK WCXCCODPAC
DO WHILE .NOT. EOF() .AND. FACCXC.CODCLI=WCXCCODPAC
   IF CANCELADO=CTOD("  -  -    ")
      STORE "PACIENTE CON DEUDA PENDIENTE. FAC No."+FACCXC.REFERENCIA TO WTEXT
      DO AVISO WITH WTEXT
   ENDIF
   SKIP
ENDDO
RETURN
******************************************************************************
*************************    R E N G L O N E S    ****************************
******************************************************************************
*************
PROC  GETGENR
*************
PUSH KEY CLEAR
DEFI WIND WINDDE FROM 10,0 TO 19,79;
          TITLE " BIENES y SERVICIOS " ;
          FOOTER " F1=Inc, F2=Mod, F3=Eli, F4=Act.Prec, Esc=Salir " ;
          DOUBLE NOFLOAT NOZOOM NOGROW COLOR SCHEME 10
ACTI WIND WINDDE
ON KEY LABEL F1 DO PRORENI
ON KEY LABEL F2 DO PRORENM
ON KEY LABEL F3 DO PRORENE
ON KEY LABEL F5 DO PRORENP
STORE FACDCGE.NUMERO TO WNUMGEN
STORE SPACE(3)       TO WLASTAREA
STORE SPACE(8)       TO WLASTEJE
SELECT FACDCDE
GO BOTT
BROWSE FIELDS WITEMDES=FUNCITEM():H="Descripcion",;
              FACDCDE.CANTIDAD:H="Cant":P="99.99",;
              FACDCDE.PRECIO:P="9999,999.99",;
              FACDCDE.DESCUENTO:P="99.99":H="Dscto",;
              WTOTRENG=FUNTOTREN():H="Tot.renglon":P="9999,999.99",;
              FACDCDE.EJECUTOR:H="AUTOR",;
              FACDCDE.AREA:H="AREA";
       NOAPPEND NODELETE NOEDIT NOMENU NOOPTIMIZE REST SAVE IN WINDOW WINDDE;
       WHEN FUNSHTOT();
       KEY FACDCGE.NUMERO
SELECT FACDCGE
RELE   WIND WINDDE
DEACT  WIND WINDTT
POP KEY
RETURN
*************
FUNC FUNSHTOT
*************
ACTI WIND WINDTT
@ 0,55 SAY "SUBTOTAL :"
@ 0,65 SAY FACDCGE.MONTO PICTURE "999,999,999.99"
ACTI WIND WINDDE
RETURN
************
PROC PRORENI
************
IF M.REFERENCIA=SPACE(10)
   PUSH KEY CLEAR       
   STORE "INCLUIR"   TO WFLAGR
   SELECT FACDCDE
   SCATT MEMV BLANK
   STORE WNUMGEN     TO M.NUMERO
   STORE "S"         TO M.TIPITEM
   STORE 1           TO M.CANTIDAD 
   STORE WLASTEJE    TO M.EJECUTOR
   STORE SPACE(1)    TO WHONOR  
   DO GETREN
   DO TOTGENR
   DO FUNSHTOT  
   SELECT FACDCDE
   POP KEY
ENDIF
RETURN
************
PROC PRORENM
************
PUSH KEY CLEAR
STORE "MODIFICAR" TO WFLAGR
SELECT FACDCDE
SCATT MEMV
STORE SPACE(1)    TO WHONOR  
DO GETREN
DO TOTGENR
DO FUNSHTOT
SELECT FACDCDE 
POP KEY
RETURN
************
PROC PRORENE
************
IF M.REFERENCIA=SPACE(10)
   PUSH KEY CLEAR
   STORE "ELIMINAR" TO WFLAGR
   STORE 2 TO WOP
   DO PROCOPC WITH WFLAGR
   IF WOP=1
      SELECT FACDCDE
      IF RECLOC()
         DELETE
         UNLOCK
         DO TOTGENR
         DO FUNSHTOT  
         SELECT FACDCDE 
      ELSE
         DO PROCNUL
      ENDIF
   ENDIF
   POP KEY
ENDIF
RETURN
************
PROC PRORENP
************
PUSH KEY CLEAR
STORE "ACT. PRECIO RENGLON" TO WFLAGACT
STORE 1 TO WOP
DO PROCOPC WITH WFLAGACT
IF WOP=1
   SELECT FACDCDE
   IF FACDCDE.TIPITEM="B"
      SELECT ALMART
      SEEK FACDCDE.ITEM
   ELSE
      SELECT SYSSERVI
      SEEK ALLTRIM(FACDCDE.ITEM)
   ENDIF
   IF FOUND()
      STORE  PRECIO TO WPRECIO
   ELSE
      STORE "ITEM: "+FACDCDE.ITEM+" NO REGISTRADO" TO WTEXT
      DO AVISO WITH WTEXT
      STORE 0       TO WPRECIO
   ENDIF
   SELECT FACDCDE
   IF WPRECIO>0
      IF RECLOC()
         REPLACE PRECIO WITH WPRECIO
         FLUSH
         UNLOCK ALL
      ELSE
         DO PROCNUL
      ENDIF
   ENDIF
   DO TOTGENR
   DO FUNSHTOT  
   SELECT FACDCDE 
ENDIF
POP KEY
RETURN
***********
PROC GETREN
***********
DEFI WIND WINDGETR FROM 11,0 TO 22,79;
          TITLE  WFLAGR ;
          DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
ACTI WIND WINDGETR
@ 0,1 SAY "Tipo (B/S) :" 
@ 1,1 SAY "Codigo     :" 
@ 2,1 SAY "Descripcion:"
@ 3,1 SAY "Cantidad   :"
@ 4,1 SAY "Precio     :" 
@ 5,1 SAY "Descuento  :"
@ 6,1 SAY "Total      :"
@ 7,1 SAY "Area  serv.:"
@ 8,1 say "Autor serv.:"
IF WFLAGR="INCLUIR"
   @ 00,14 GET M.TIPITEM          VALID VALTIP()  
   READ
   IF LASTKEY()=27
      DEACT WIND WINDGETR
      RETURN
   ENDIF
   @ 01,14 GET M.ITEM             VALID VALITE()  
   READ
   IF M.ITEM=SPACE(20)
      DEACT WIND WINDGETR
      RETURN
   ENDIF
ELSE
   DO VALITE   
   @ 00,14 SAY M.TIPITEM      
   @ 01,14 SAY M.ITEM         
ENDIF
*
IF M.REFERENCIA=SPACE(10).OR.WUSERCODE="EDUARDO "
   
   @ 03,17 GET M.CANTIDAD         PICTURE "999,999.99" RANGE 0.01,999999.99
   READ
   IF M.PRECIO > 0
      @ 04,14  SAY M.PRECIO       PICTURE "99,999,999.99"
   ELSE                          
      @ 04,14 GET M.PRECIO           PICTURE "99,999,999.99" 
      READ
   ENDIF

   *@ 05,21 GET M.DESCUENTO       PICTURE "999.99" RANGE 0,100
   *READ

   STORE FUNTOTRE() TO WTOTREN
   @ 06,14 SAY WTOTREN            PICTURE "99,999,999.99"  
   IF LASTKEY()=27
      DEACT WIND WINDGETR
      RETURN
   ENDIF

   IF M.AREA=SPACE(3)
      STORE WLASTAREA   TO M.AREA
      IF WFLAGMED
         STORE WUSERUBI TO M.AREA
      ENDIF
      @ 07,14 GET M.AREA VALID VALAREA()   
      READ
      IF M.AREA=SPACE(3)
         DEACT WIND WINDGETR
         RETURN
      ENDIF
   ELSE
      @ 07,14 SAY M.AREA 
   ENDIF
   STORE M.AREA TO WLASTAREA
   
   IF M.TIPITEM="S" .AND. WHONOR="S"
      IF WFLAGMED
         STORE WUSERCODE          TO M.EJECUTOR
      ENDIF
      @ 08,14 GET M.EJECUTOR      VALID VALAUTOR() 
      READ
      IF M.EJECUTOR=SPACE(8)
         DEACT WIND WINDGETR
         RETURN
      ENDIF
      STORE M.EJECUTOR             TO WLASTEJE
   ELSE
      STORE SPACE(8)               TO M.EJECUTOR
   ENDIF

ELSE

   @ 03,17 SAY M.CANTIDAD         PICTURE "999,999.99" 
   @ 04,14 SAY M.PRECIO           PICTURE "99,999,999.99" 
   *@ 05,21 GET M.DESCUENTO        PICTURE "999.99" RANGE 0,100
   *READ
   STORE FUNTOTRE() TO WTOTREN
   @ 06,14 SAY WTOTREN            PICTURE "99,999,999.99"  
   *DO VALAREA
   *DO VALAUTOR

ENDIF
STORE FUNTOTRE() TO WTOTREN
@ 6,14 SAY WTOTREN             PICTURE "99,999,999.99"

IF WFLAGR="INCLUIR"
   STORE 1 TO WOP
ELSE
   STORE 1 TO WOP
   DO PROCOPC WITH WFLAGR
ENDIF
IF WOP=1
   SELECT FACDCDE
   STORE "FAC"      TO M.ORIGEN
   STORE WUSERUBI   TO M.DEPTO
   STORE WUSERCODE  TO M.USUARIO
   STORE DATE()     TO M.USUARIOF
   IF WFLAGR="INCLUIR"
      IF FILLOC()
         APPEND BLANK
         GATH MEMV
         FLUSH
         UNLOCK ALL
      ELSE
        DO PROCNUL
      ENDIF
   ELSE
      IF RECLOC()
         GATH MEMV
         FLUSH
         UNLOCK ALL
      ELSE
        DO PROCNUL
      ENDIF
   ENDIF
ENDIF
DEACT WIND WINDGETR
RETURN
************
PROC TOTGENR
************
STORE 0 TO WSUBDOC
SELECT FACDCDE
SEEK FACDCGE.NUMERO
DO WHILE.NOT.EOF() .AND. FACDCDE.NUMERO=FACDCGE.NUMERO
   STORE AREA                                     TO M.AREA
   STORE FUNTOTREN()                              TO WTOTRENG
   STORE WSUBDOC+WTOTRENG                         TO WSUBDOC
   SKIP
ENDDO
STORE WSUBDOC*(WPORIMP/100)                       TO WSUBIMP
STORE WSUBDOC+WSUBIMP                             TO WMONTO
SELECT FACDCGE
IF RECLOC()
   REPLACE AREA       WITH M.AREA        
   REPLACE SUBDOC     WITH WSUBDOC
   REPLACE PORIMP     WITH WPORIMP
   REPLACE SUBIMP     WITH WSUBIMP
   REPLACE MONTO      WITH WMONTO
   FLUSH
   UNLOCK ALL
ELSE
   STORE "ACTUALIZACION RECHAZADA, FAVOR EDITAR NUEVAMENTE" TO WTEXT
   DO AVISO WITH WTEXT
ENDIF
SELECT FACDCDE
RETURN
*************
FUNC FUNCITEM
*************
PUSH KEY CLEAR
IF FACDCDE.TIPITEM="B"
   SELECT ALMART
   SEEK FACDCDE.ITEM
   IF FOUND()
      STORE  DESCRI                  TO WDESITEM
   ELSE
      STORE  "NO REG. EN ARTICULOS"  TO WDESITEM
   ENDIF
ELSE
   IF FACDCDE.TIPITEM="S"
      SELECT SYSSERVI
      SEEK ALLTRIM(FACDCDE.ITEM)
      IF FOUND()
         STORE  DESCRI                 TO WDESITEM
      ELSE
         STORE  "NO REG. EN SERVICIOS" TO WDESITEM
      ENDIF
   ELSE
      STORE FACDCDE.ITEM              TO WDESITEM
   ENDIF
ENDIF
POP KEY
SELECT FACDCDE
RETURN SUBSTR(WDESITEM,1,30)
***********
FUNC VALTIP
***********
IF M.TIPITEM="B".OR.M.TIPITEM="S"
   RETURN .T.
ELSE
   RETURN .F.
ENDIF
***********
FUNC VALITE
***********
IF M.TIPITEM="B"
   PUSH KEY CLEAR
   DO WHILE .T.
      IF LEN(ALLTRIM(M.ITEM))<>0
         SELECT ALMART
         SEEK M.ITEM
         IF .NOT.FOUND()
           PUSH KEY CLEAR
           DO MEDCONVA
           POP KEY
           STORE CODIGO TO M.ITEM
         ELSE
            @ 2,14 SAY DESCRI
            IF WFLAGR="INCLUIR"
               STORE CODIGO             TO M.ITEM
               IF WNIVEL=SPACE(1)
                  STORE PRECIOA         TO M.PRECIO
               ELSE
                  STORE "PRECIO"+WNIVEL TO WPRECIO
                  STORE &WPRECIO        TO M.PRECIO
               ENDIF
            ENDIF
            EXIT
         ENDIF
      ELSE
         PUSH KEY CLEAR
         DO MEDCONVA
         POP KEY
         STORE CODIGO TO M.ITEM
      ENDIF
   ENDDO
   SELECT FACDCDE
   POP KEY
   RETURN .T. 
ELSE
   PUSH KEY CLEAR
   DO WHILE .T.
      IF LEN(ALLTRIM(M.ITEM))<>0
         SELECT SYSSERVI
         SEEK SUBSTR(M.ITEM,1,12)
         IF .NOT.FOUND()
            DO PROWINSE
            STORE SYSSERVI.SERVICIO TO M.ITEM
            LOOP
         ELSE
            @ 2,14 SAY DESCRI
            IF WFLAGR="INCLUIR"
               STORE SYSSERVI.SERVICIO           TO M.ITEM
               IF SYSSERVI.PUNTO<>SPACE(3)
                  STORE SYSSERVI.PUNTO           TO M.AREA
               ELSE
                  STORE SPACE(3)                 TO M.AREA
               ENDIF
               STORE SYSSERVI.HONORARIO          TO WHONOR
               IF WNIVEL=SPACE(1)
                  STORE SYSSERVI.PRECIOA         TO M.PRECIO
               ELSE
                  STORE "PRECIO"+WNIVEL          TO WPRECIO
                  STORE &WPRECIO                 TO M.PRECIO
               ENDIF
            ELSE
               STORE SYSSERVI.SERVICIO           TO M.ITEM
               IF SYSSERVI.PUNTO<>SPACE(3)
                  STORE SYSSERVI.PUNTO           TO M.AREA
               ELSE
                  STORE SPACE(3)                 TO M.AREA
               ENDIF
               STORE SYSSERVI.HONORARIO          TO WHONOR
               *IF WNIVEL=SPACE(1)
               *   STORE SYSSERVI.PRECIOA         TO M.PRECIO
               *ELSE
               *   STORE "PRECIO"+WNIVEL          TO WPRECIO
               *   STORE &WPRECIO                 TO M.PRECIO
               *ENDIF
            ENDIF
            EXIT
         ENDIF
      ELSE
         DO PROWINSE
         STORE SYSSERVI.SERVICIO TO M.ITEM
         LOOP
      ENDIF
   ENDDO
   SELECT FACDCDE
   POP KEY
   RETURN .T. 
ENDIF
RETURN
*************
PROC PROWINSE
*************
STORE 05 TO LIBRSER
STORE 00 TO CIBRSER
PUSH KEY CLEAR
DO SERWINSE
POP KEY
IF (LEN(ALLTRIM(SYSSERVI.SERVICIO))<>12)
   STORE SPACE(12)          TO M.ITEM
   STORE "Selecci¢n es un titulo. Intente con otro" TO WTEXT
   DO AVISO WITH WTEXT
ELSE
   STORE SYSSERVI.SERVICIO  TO M.ITEM
ENDIF
IF LEN(ALLTRIM(SYSSERVI.SERVICIO))<>12
   STORE SPACE(12)          TO M.ITEM
ELSE
   STORE SYSSERVI.SERVICIO  TO M.ITEM
ENDIF
SELECT FACDCDE
RETURN
************
FUNC VALAREA
************
SELECT SYSPTO
DO WHILE .T.
   SEEK M.AREA
   IF .NOT. FOUND()
      librpto=5
      cibrpto=0
      DO SERWINPT
      STORE CODPTO TO M.AREA
      LOOP
   ELSE
      @ 07, 25 SAY DESCRI 
      EXIT
   ENDIF
ENDDO
SELECT FACDCDE
RETURN
*************
FUNC VALAUTOR
*************
SELECT SYSMED
SET ORDER TO SYSMED3
DO WHILE .T.
   GO TOP
   LOCATE FOR USERCODE=M.EJECUTOR
   IF .NOT. FOUND() .OR. M.EJECUTOR=SPACE(8)
      librmed=5
      cibrmed=0
      DO SERWINME
      STORE USERCODE TO M.EJECUTOR
   ELSE
      @ 08, 25 SAY NOMBRE 
      SET ORDER TO SYSMED1
      EXIT
   ENDIF
ENDDO
IF SYSMED.AREA<>SPACE(3).AND.SYSMED.AREA<>M.AREA
   STORE "Esta persona labora en el area "+sysmed.area+". Intente con otro" to wtext
   DO AVISO WITH WTEXT
   RETURN .F.
ENDIF
RETURN .T.
************
PROC PROCOPC
************
PARA WTITLE
DEFI WIND WINDCON FROM 12,19 TO 14,59;
          TITLE WTITLE;
          DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
ACTIVATE WIND WINDCON
DO WHILE .T.
   @ 00,03 SAY "OPCIONES: ";
   GET WOP PICT "@*H ACEPTAR  ;CANCELAR "
   READ
   IF LASTKEY()=13
      EXIT
   ENDIF
ENDDO
RELE WIND WINDCON
RETURN
*************
PROC PROCOPC2
*************
PARA WTITLE
DEFI WIND WINDCON FROM 12,19 TO 14,59;
          TITLE WTITLE;
          DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
ACTIVATE WIND WINDCON
DO WHILE .T.
   @ 00,03 SAY "OPCIONES: ";
   GET WOP PICT "@*H CANCELAR ;ACEPTAR  "
   READ
   IF LASTKEY()=13
      EXIT
   ENDIF
ENDDO
RELE WIND WINDCON
RETURN
************
PROC PROCNUL
************
STORE "OPERACION RECHAZADA, FAVOR REINTENTAR." TO WTEXT
DO AVISO WITH WTEXT
RETURN
*************
FUNC FUNTOTRE
*************
STORE M.CANTIDAD*(M.PRECIO-(M.PRECIO*M.DESCUENTO/100)) TO WTOTRENG
RETURN WTOTRENG
**************
FUNC FUNTOTREN
**************
STORE FACDCDE.CANTIDAD*(FACDCDE.PRECIO-(FACDCDE.PRECIO*FACDCDE.DESCUENTO/100)) TO WTOTRENG
RETURN WTOTRENG

