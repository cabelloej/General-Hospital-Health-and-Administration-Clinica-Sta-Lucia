SELECT SERDCGE
SET ORDER TO SERDCGE

*** BUSCA LA SOLICITUD
SEEK M.REFERENCIA
IF .NOT. FOUND()
   STORE M.REFERENCIA+" NO EXISTE. <ENTER>" TO MES
   DO AVISO WITH MES
   STORE SPACE(10) TO M.REFERENCIA
   RETURN
ENDIF

*** VERIFICA QUE ESTE PROCESADA ADMINISTRATIVAMENTE
IF SERDCGE.CUENTA=SPACE(10).AND.SERDCGE.FACTURA=SPACE(10).AND.SERDCGE.MONTO>0
   STORE "ERROR, PRIMERO FACTURE LA SOLICITUD "+SUBSTR(SERDCGE.NUMERO,4,7)+" O CARGELA A UNA CUENTA" TO MES
   DO AVISO WITH MES
   STORE SPACE(10) TO M.REFERENCIA
   RETURN
ENDIF

***
IF SERDCGE.COMPROB<>SPACE(10)
   STORE "ERROR, SOLICITUD YA PROCESADA CON COMPROBANTE: "+SUBSTR(SERDCGE.COMPROB,4,7) TO MES
   DO AVISO WITH MES
   STORE SPACE(10) TO M.REFERENCIA
   RETURN
ENDIF

*** VERIFICA QUE EL OPERADOR SEA DE LA UBICACION DEL EJECUTOR
IF .NOT. SERDATA.COMSINARE .AND. SERDCGE.PROVEEDOR <> WUSERUBI 
   STORE "ERROR, SOLICITUD DIRIGIDA AL AREA :"+SERDCGE.PROVEEDOR TO  MES
   DO AVISO WITH MES
   STORE SPACE(10) TO M.REFERENCIA
   RETURN
ENDIF

*** VERIFICAR LOS RENG. DE LA REF.
SELECT SERDCDE
STORE 0 TO WTOTPRO
SEEK M.REFERENCIA
DO WHILE .NOT. EOF() .AND. NUMERO = M.REFERENCIA
   *** ATENCION CORRECTA.
   IF TIPITEM="B"
      SELECT ALMART
      SET ORDER TO 1
      SEEK SERDCDE.ITEM
      IF .NOT. FOUND()
         STORE "CODIGO DE BIEN:"+ALLTRIM(SERDCDE.ITEM)+"NO REGISTRADO EN ALMACEN" TO MES
         DO AVISO WITH MES
         SELECT SERDCDE
         SKIP
         LOOP
      ENDIF
   ELSE
      SELECT SYSSERVI
      SEEK SUBSTR(SERDCDE.ITEM,1,9)
      IF .NOT. FOUND()
         STORE "CODIGO DE SERV:"+ALLTRIM(SERDCDE.ITEM)+", NO REGISTRADO EN SERVICIOS" TO MES
         DO AVISO WITH MES
         SELECT SERDCDE
         SKIP
         LOOP
      ELSE
         IF .NOT. SERDATA.COMSINARE .AND. SERDCGE.PROVEEDOR<>WUSERUBI
            STORE "CODIGO DE SERV:"+ALLTRIM(SERDCDE.ITEM)+" NO PERTENECE A SU AREA DE SERVICIO" TO MES
            DO AVISO WITH MES
            SELECT SERDCDE
            SKIP
            LOOP
         ENDIF
      ENDIF
   ENDIF
   **************
   SELECT SERDCDE
   STORE RECNO()   TO WRECDE
   STORE RENGLON   TO WREN
   STORE TIPITEM   TO WTIP
   STORE ITEM      TO WITE
   STORE CANTIDAD  TO WCAN
   STORE PRECIO    TO WPRE
   STORE DESCUENTO TO WDES   
   IF FILLOC()
      APPEND BLANK
      REPLACE NUMERO    WITH M.NUMERO
      REPLACE RENGLON   WITH WREN
      REPLACE TIPITEM   WITH WTIP
      REPLACE ITEM      WITH WITE
      REPLACE CANTIDAD  WITH WCAN
      REPLACE PRECIO    WITH WPRE
      REPLACE DESCUENTO WITH WDES
      ***
      REPLACE ORIGEN      WITH "SER"
      REPLACE DEPTO       WITH WUSERUBI
      REPLACE USUARIO     WITH WUSERCODE
      REPLACE USUARIOF    WITH DATE()
      FLUSH
      UNLOCK ALL
   ENDIF
   STORE WTOTPRO + 1 TO WTOTPRO
   GO WRECDE
   SKIP
ENDDO
SELECT SERDCGE
IF WTOTPRO > 0
   SCATT MEMVAR
   STORE SUBSTR(M.CODPAC,1,10)      TO WCODPAC1
   STORE VAL(SUBSTR(M.CODPAC,11,4)) TO WCODPAC2
   STORE WNUMEROREF                 TO M.NUMERO
   STORE WCLAVEREF                  TO M.REFERENCIA
   STORE WUSERUBI                   TO M.DEPTO
   STORE WUSERCODE                  TO M.USUARIO
   STORE DATE()                     TO M.USUARIOF
   IF FILLOC()
      APPEND BLANK
      GATH MEMVAR
      FLUSH
      STORE RECNO() TO WREGDOC
      SEEK WCLAVEREF
      IF EOF()
         STORE "ERROR: DESAPARECIO LA SOLICITUD. NO PUDO SER MARCADA COMO EJECUTADA" TO MES
         DO AVISO WITH MES
      ELSE
         REPLACE COMPROB WITH M.NUMERO
         FLUSH
      ENDIF
      UNLOCK ALL
   ENDIF
ENDIF
SELECT SERDCGE
GO WREGDOC
RETURN

