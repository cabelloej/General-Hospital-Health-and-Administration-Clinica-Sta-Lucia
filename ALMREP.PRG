IF FLAGASK
   SELECT ALMART
   IF RECLOC()
      REPLACE ALL FLAGREPRO WITH "S"
      UNLOCK ALL
   ELSE
      RETURN
   ENDIF
ENDIF
STORE "REPROCESANDO MOVIMIENTOS DE LOS ARTICULOS AFECTADOS. FAVOR ESPERAR..." TO MES
DO MENSAJE WITH MES
SELECT ALMART
GO TOP
LOCATE FOR FLAGREPRO = "S"
DO WHILE .NOT. EOF()
   STORE UNIAPE TO WUNIEXI
   STORE COSAPE TO WCOSEXI
   STORE CODIGO TO WCODIGO
   STORE .F. TO WFLAGULT
   SELECT ALMTRA
   SET ORDER TO ALMTRA1
   FIND &WCODIGO
   DO WHILE .NOT. EOF() .AND. CODIGO = WCODIGO
      STORE RECNO()    TO WREGORI
      STORE OPERACION  TO WOPE
      STORE REFERENCIA TO WNUMERO
      STORE UNIDADES   TO WUNIDADES
      STORE COSTO      TO WCOSTO
      STORE ORIGEN     TO WORIGEN
      DO CASE
      CASE WOPE = "EN"
           STORE ((WCOSEXI*WUNIEXI)+(WCOSTO)) / (WUNIEXI+WUNIDADES) TO WCOSEXI
           STORE WUNIEXI + WUNIDADES TO WUNIEXI
           *** DATOS DE ULTIMA COMPRA
           STORE .T.        TO WFLAGULT
           STORE FECHA      TO WULTFECHA
           STORE UNIDADES   TO WULTCANTI
           STORE COSTO      TO WULTCOSTO
           STORE REFERENCIA TO WULTREFEREN
           STORE PROCLI     TO WULTPROCLI
      CASE WOPE = "SA"
           STORE  WUNIEXI - WUNIDADES TO WUNIEXI
           IF RECLOC()
              REPLACE COSTO WITH WCOSEXI*WUNIDADES
              UNLOCK ALL
           ELSE
              RETURN
           ENDIF
      CASE WOPE = "AE"
           STORE WUNIEXI + WUNIDADES TO WUNIEXI
      CASE WOPE = "AS"
           STORE WUNIEXI - WUNIDADES TO WUNIEXI
      CASE WOPE = "AC"
           STORE  ((WCOSEXI*WUNIEXI)+WCOSTO) / WUNIEXI   TO WCOSEXI
      CASE WOPE = "DE"
           STORE ( (WCOSEXI*WUNIEXI) - WCOSTO ) / (WUNIEXI-WUNIDADES) TO WCOSEXI
           STORE  WUNIEXI - WUNIDADES TO WUNIEXI
      CASE WOPE = "DS"
           STORE ( (WCOSEXI*WUNIEXI) + WCOSTO ) / (WUNIEXI+WUNIDADES) TO WCOSEXI
           STORE  WUNIEXI + WUNIDADES TO WUNIEXI
      ENDCASE
      SKIP
   ENDDO
   SELECT ALMART
   IF RECLOC()
      REPLACE FLAGREPRO WITH SPACE(1)
      REPLACE UNIEXI WITH WUNIEXI
      REPLACE COSEXI WITH WCOSEXI
      IF WFLAGULT
         REPLACE ULTCOMPRA    WITH WULTFECHA
         REPLACE ULTCANTI     WITH WULTCANTI
         REPLACE ULTCOSTO     WITH WULTCOSTO
         REPLACE ULTREFEREN   WITH WULTREFEREN
         REPLACE ULTPROVE     WITH WULTPROCLI
         UNLOCK ALL
      ENDIF
   ELSE
      RETURN
   ENDIF
   CONTINUE
ENDDO

