SELECT FACDCGE
SET ORDER TO FACDCGE
SEEK WNUMERO2
IF .NOT. FOUND()
   STORE "NUMERO DE FACTURA :"+WNUMERO2+" NO REGISTRADA, VERIFIQUE" TO WTEXT
   DO AVISO WITH WTEXT
   RETURN
ENDIF
STORE 0   TO WPAGINA
STORE 0   TO WTOTREN
STORE 0   TO WTOTPRE
STORE 100 TO WLINEA
IF WSALIDA = 2
   DEFI WIND WINDSAL FROM 0,0 TO 25,81;
          NONE NOFLOAT NOZOOM NOGROW NOSHADOW COLOR SCHEME 10
   ACTI WIND WINDSAL
   STORE 21 TO WSALTO
ELSE
   SET DEVI TO PRINT
   STORE 30 TO WSALTO
   IF .NOT. WFLAGPRINT
      @ PROW(), PCOL() SAY CHR(18)
      @ PROW(), PCOL() SAY CHR(27)+CHR(67)+CHR(33)
      STORE .T. TO WFLAGPRINT
   ENDIF
ENDIF

STORE "**"       TO WRUPTIP
STORE "**-**"    TO WRUPESP
STORE "**-**-**" TO WRUPGRU
STORE .T.        TO WFLAGMDCO
SELECT FACDCDE
SEEK WNUMERO2
DO WHILE .NOT.EOF().AND.NUMERO=WNUMERO2
   STORE SUBSTR(ITEM,1,2) TO WTIP
   STORE SUBSTR(ITEM,1,5) TO WESP
   STORE SUBSTR(ITEM,1,8) TO WGRU
   DO RUPTURA
   ***
   IF FACDCDE.TIPITEM="B"
      SELECT ALMART
      SEEK FACDCDE.ITEM
   ELSE
      SELECT SYSSERVI
      SEEK ALLTRIM(FACDCDE.ITEM)
   ENDIF
   IF FOUND()
      STORE  DESCRI TO WNOMITEM
   ELSE
      STORE FACDCDE.ITEM+" NO REGISTRADO" TO WNOMITEM
   ENDIF
   STORE WLINEA+1 TO WLINEA
   DO VERSALTO
   SELECT FACDCDE
   IF WSALIDA=2
      @ WLINEA,00 SAY SUBSTR(WNOMITEM,1,40)
   ELSE
      @ WLINEA,00 SAY CHR(18)+CHR(15)+"* "+WNOMITEM+" ("+FACDCDE.EJECUTOR+")"+CHR(18)
      @ WLINEA,00 SAY CHR(18)+CHR(15)+"* "+WNOMITEM+" ("+FACDCDE.EJECUTOR+")"+CHR(18)
   ENDIF
   @ WLINEA,41 SAY CANTIDAD   PICTURE "9999.99"
   @ WLINEA,49 SAY PRECIO     PICTURE "9999999.99"
   @ WLINEA,60 SAY DESCUENTO  PICTURE "99.99"
   STORE CANTIDAD*(PRECIO-(PRECIO*DESCUENTO/100)) TO WTOTREN
   @ WLINEA,66 SAY WTOTREN    PICTURE "99,999,999.99"
   *STORE WTOTPRE+WTOTREN TO WTOTPRE
   SELECT FACDCDE
   SKIP
ENDDO
STORE WLINEA+1 TO WLINEA
DO VERSALTO
@ WLINEA,00 SAY REPLICATE("-",79)

IF FACDCGE.SUBIMP > 0
   STORE WLINEA+1 TO WLINEA
   DO VERSALTO
   @ WLINEA,36 SAY "SUBTOTAL FACTURA  :"
   @ WLINEA,36 SAY "SUBTOTAL FACTURA  :"
   @ WLINEA,66 SAY FACDCGE.SUBDOC PICTURE "99,999,999.99"
   STORE WLINEA+1 TO WLINEA
   DO VERSALTO
   @ WLINEA,36 SAY "TOTAL IMPUESTOS   :"
   @ WLINEA,36 SAY "TOTAL IMPUESTOS   :"
   @ WLINEA,66 SAY FACDCGE.SUBIMP PICTURE "99,999,999.99"
ENDIF
STORE WLINEA+1 TO WLINEA
DO VERSALTO
@ WLINEA,36 SAY "TOTAL FACTURA     :"
@ WLINEA,36 SAY "TOTAL FACTURA     :"
@ WLINEA,66 SAY FACDCGE.MONTO  PICTURE "99,999,999.99"
@ WLINEA+1,00 SAY CHR(18)+CHR(15)+"Sistema personalizado a nombre de "+qqww
IF WSALIDA=2
   STORE "OPRIMA ENTER PARA FINALIZAR" TO WTEXT
   DO AVISO WITH WTEXT
   RELE WIND WINDSAL
ELSE
   *IF .NOT. WFLAGPRINT
   *   @ PROW(), PCOL() SAY CHR(27)+CHR(67)+CHR(66)
   *   @ PROW(), PCOL() SAY CHR(18)
   *ENDIF
   EJECT
   SET DEVI TO SCRE
ENDIF
*** COPIA EL MONTO IMPRESO AL CAMPO QUE LO ENVIA A GRABAR.
STORE WTOTPRE TO WSUBDOC
RETURN
************************************************************************
*************
PROC VERSALTO
*************
IF WLINEA>WSALTO
   IF WSALIDA=2.AND.WPAGINA>0
      STORE "OPRIMA ENTER PARA CONTINUAR" TO WTEXT
      DO AVISO WITH WTEXT
   ENDIF
   DO HEADING
ENDIF
RETURN
*************
PROC HEADING
************
STORE WPAGINA+1 TO WPAGINA
IF WSALIDA = 2
   @ 00,00 CLEAR
   @ 00,00 SAY QQWW
   @ 01,00 SAY WDIRECC1
   @ 01,55 SAY "Factura     :"+SUBSTR(FACDCGE.NUMERO,4,7)
   @ 02,00 SAY WDIRECC2
   @ 02,55 SAY "Elaboracion :"+DTOC(FACDCGE.ELABORADO)
   @ 03,00 SAY WDIRECC3
   @ 03,55 SAY "Vencimiento :"+DTOC(FACDCGE.VENCE)
   @ 04,00 SAY "R.I.F.: "+ WRIF+" N.I.T.: "+WNIT
   @ 04,55 SAY "Pagina      :"+ALLTRIM(STR(WPAGINA,3))
ELSE
   *@ 00,00 SAY CHR(14)+QQWW
   *@ 00,00 SAY CHR(14)+QQWW
   *@ 01,00 SAY CHR(15)+WDIRECC1
   @ 01,00 SAY CHR(18)
   @ 01,57 SAY "Factura     :"
   @ 01,56 SAY "Factura     :"+SUBSTR(FACDCGE.NUMERO,4,7)
   *@ 02,00 SAY CHR(15)+WDIRECC2
   *@ 02,00 SAY CHR(18)
   @ 02,56 SAY "Elaboracion :"
   @ 02,56 SAY "Elaboracion :"+DTOC(FACDCGE.ELABORADO)
   *@ 03,00 SAY CHR(15)+WDIRECC3
   *@ 03,00 SAY CHR(18)
   @ 03,56 SAY "Vencimiento :"
   @ 03,56 SAY "Vencimiento :"+DTOC(FACDCGE.VENCE)
   *@ 04,00 SAY CHR(15)+"R.I.F.: "+ WRIF+" N.I.T.: "+WNIT
   *@ 04,00 SAY CHR(18)
   @ 04,56 SAY "Pagina      :"
   @ 04,56 SAY "Pagina      :"+ALLTRIM(STR(WPAGINA,3))
   @ 04,00 SAY CHR(18)
ENDIF
IF SUBSTR(FACDCGE.CODCLI,1,1)="*"
   STORE FACDCGE.DESCLI          TO WNOMCLI
ELSE
   SELECT FACCLI
   SEEK FACDCGE.CODCLI
   IF FOUND()
      STORE DESCLI                TO WNOMCLI
   ELSE
      STORE "NO REG. EN CLIENTES" TO WNOMCLI
   ENDIF
ENDIF
STORE FACDCGE.TIPPAC TO M.TIPPAC
STORE FACDCGE.CODPAC TO M.CODPAC
IF FACDCGE.PAGOFOR="C"
   STORE "Contado"   TO WFORMAPAG
ELSE
   STORE "Credito"   TO WFORMAPAG
ENDIF
STORE SPACE(30)      TO WNOMPAC
DO VALPAC
STORE FACDCGE.AREA   TO M.AREA
STORE SPACE(30)      TO WNOMAREA
DO VALAREA
@ 06,00 SAY "Cliente    : "
@ 06,00 SAY "Cliente    : "+ALLTRIM(FACDCGE.CODCLI)+" "+WNOMCLI
@ 07,00 SAY "Paciente   : "
@ 07,00 SAY "Paciente   : "+ALLTRIM(SUBSTR(FACDCGE.CODPAC,1,10))+"-"+ALLTRIM(SUBSTR(FACDCGE.CODPAC,11,4))+" "+WNOMPAC
@ 08,00 SAY "Atendido en: "
@ 08,00 SAY "Atendido en: "+WNOMAREA+" Serial: "+ALLTRIM(STR(FACDCGE.SERIALESPE,7))
@ 09,00 SAY "Forma Pago : "
@ 09,00 SAY "Forma Pago : "+WFORMAPAG
@ 10,00 SAY replicate("-",79)
@ 10,00 SAY replicate("-",79)
@ 11,00 say "Descripcion"
@ 11,00 say "Descripcion"
@ 11,41 say " Cantd."
@ 11,41 say " Cantd."
@ 11,49 say "    Precio"
@ 11,49 say "    Precio"
@ 11,60 say "%Desc."
@ 11,60 say "%Desc."
@ 11,66 say "  Total Reng."
@ 11,66 say "  Total Reng."
@ 12,00 SAY replicate("-",79)
@ 12,00 SAY replicate("-",79)
STORE 13 TO WLINEA
RETURN
************
PROC RUPTURA
************
IF WTIP<>WRUPTIP.OR.WESP<>WRUPESP.OR.WGRU<>WRUPGRU
   IF FACDCDE.TIPITEM="S"
      IF WTIP<>WRUPTIP
         SELECT SYSSERVI
         SEEK WTIP+"-  -  -   "
         IF FOUND()
            STORE DESCRI     TO WNOMTIP
         ELSE
            STORE SPACE(1)   TO WNOMTIP
         ENDIF
         IF WNOMTIP<>SPACE(1)
            STORE WLINEA+1 TO WLINEA
            DO VERSALTO
            @ WLINEA,40-LEN(ALLTRIM(WNOMTIP))/2 SAY ALLTRIM(WNOMTIP)
            @ WLINEA,40-LEN(ALLTRIM(WNOMTIP))/2 SAY ALLTRIM(WNOMTIP)
         ENDIF
         STORE WTIP       TO WRUPTIP
         STORE "**-**"    TO WRUPESP
         STORE "**-**-**" TO WRUPGRU
      ENDIF
      IF WESP<>WRUPESP
         SELECT SYSSERVI
         SEEK WESP+"-  -   "
         IF FOUND()
            STORE DESCRI TO WNOMESP
         ELSE
            STORE "****" TO WNOMESP
         ENDIF
         IF WNOMESP<>SPACE(1)
            STORE WLINEA+1 TO WLINEA
            DO VERSALTO
            @ WLINEA,00 SAY CHR(15)+WNOMESP+CHR(18)
         ENDIF
         STORE WESP       TO WRUPESP
         STORE "**-**-**" TO WRUPGRU
      ENDIF
      IF WGRU<>WRUPGRU
         SELECT SYSSERVI
         SEEK WGRU+"-   "
         IF FOUND()
            STORE DESCRI TO WNOMGRU
         ELSE
            STORE SPACE(1)    TO WNOMGRU
         ENDIF
         IF WNOMGRU<>SPACE(1)
            STORE WLINEA+1 TO WLINEA
            DO VERSALTO
            @ WLINEA,00 SAY CHR(15)+WNOMGRU+CHR(18)
         ENDIF
         STORE WGRU TO WRUPGRU
      ENDIF
   ELSE
      IF WFLAGMDCO
         STORE WLINEA+1 TO WLINEA
         DO VERSALTO
         @ WLINEA,25 SAY  "Medicamentos y Material medico"
         @ WLINEA,25 SAY  "Medicamentos y Material medico"
         *STORE WLINEA+1 TO WLINEA
         *DO VERSALTO
         *@ WLINEA,25 SAY "------------------------------"
         STORE .F. TO WFLAGMDCO
      ENDIF
   ENDIF
ENDIF
RETURN
****************
PROCEDURE VALPAC
****************
IF M.TIPPAC="A"
   SELECT AFIAFI
   SET ORDER TO AFIAFI1
   SEEK M.CODPAC
   IF .NOT. FOUND()
      STORE "PACIENTE NO AFILIADO" TO WNOMPAC
   ELSE
      STORE ALLTRIM(PAPELLIDO)+", "+ALLTRIM(PNOMBRE) TO WNOMPAC
   ENDIF
ELSE
   SELECT SYSPAC
   SEEK M.CODPAC
   IF .NOT. FOUND()
      STORE "PACIENTE NO REGISTRADO" TO WNOMPAC
   ELSE
      STORE ALLTRIM(PAPELLIDO)+", "+ALLTRIM(PNOMBRE) TO WNOMPAC
   ENDIF
ENDIF
RETURN
****************
PROCEDURE VALAREA
****************
SELECT SYSPTO
SEEK M.AREA
IF FOUND()
   STORE ALLTRIM(DESCRI) TO WNOMAREA
ENDIF
RETURN
