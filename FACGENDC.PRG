IF WTIPREF="SOL"
   *** TRANSFIERE SOLICITUD
   SELECT SERDCGE
   SEEK M.REFERENCIA
   IF EOF()
      STORE WTIPREF+". No."+WNUMREF+" NO EXISTE. <ENTER>" TO WTEXT
      DO AVISO WITH WTEXT
      RETURN
   ELSE
      *** VERIFICA QUE NO ESTE PROCESADO ADMINISTRATIVAMENTE
      IF CUENTA<>SPACE(10).OR.FACTURA<>SPACE(10)
         STORE "SOLICITUD YA FACTURADA O CARGADA A CUENTA. DOC.:"+ALLTRIM(FACTURA+CUENTA) TO WTEXT
         DO AVISO WITH WTEXT
         RETURN
      ENDIF
      *** VERIFICA QUE NO ESTE PROCESADO OPERATIVAMENTE
      IF COMPROB<>SPACE(10)
         STORE "SOLICITUD YA PROCESADA CON COMPROBANTE No.:"+COMPROB TO WTEXT
         DO AVISO WITH WTEXT
         RETURN
      ENDIF
      *** VERIFICA QUE NO SEA UNA SOLICITUD DE UN AFILIADO
      *IF TIPPAC = "A"
      *   STORE "SOLICITUD PERTERNECE A UN AFILIADO" TO WTEXT
      *   DO AVISO WITH WTEXT
      *   RETURN
      *ENDIF
      STORE TIPPAC    TO M.TIPPAC
      STORE CODPAC    TO M.CODPAC
      STORE SUBDOC    TO M.SUBDOC
      STORE PORIMP    TO M.PORIMP
      STORE SUBIMP    TO M.SUBIMP
      STORE MONTO     TO M.MONTO
      STORE PROVEEDOR TO WUBIC
      STORE PROVEEDOR TO WAREA
   ENDIF
   *** VERIFICAR LOS RENG. DE LA REF.
   SELECT SERDCDE
   STORE 0 TO WTOTPRO
   SEEK M.REFERENCIA
   DO WHILE .NOT. EOF() .AND. NUMERO = M.REFERENCIA
      STORE RENGLON   TO WREN
      STORE TIPITEM   TO WTIP
      STORE ITEM      TO WITE
      STORE CANTIDAD  TO WCAN
      STORE PRECIO    TO WPRE
      STORE EJECUTOR  TO WEJE
      SELECT FACDCDE
      IF FILLOC()
         APPEND BLANK
         REPLACE NUMERO    WITH M.NUMERO
         REPLACE RENGLON   WITH WREN
         REPLACE TIPITEM   WITH WTIP
         REPLACE ITEM      WITH WITE
         REPLACE CANTIDAD  WITH WCAN
         REPLACE PRECIO    WITH WPRE
         REPLACE AREA      WITH WAREA
         REPLACE EJECUTOR  WITH WEJE

         REPLACE ORIGEN    WITH "FAC"
         REPLACE DEPTO     WITH WUSERUBI
         REPLACE USUARIO   WITH WUSERCODE
         REPLACE USUARIOF  WITH DATE()
         FLUSH
         UNLOCK ALL
      ENDIF
      STORE WTOTPRO + 1 TO WTOTPRO
      SELECT SERDCDE
      SKIP
   ENDDO
   *****
   IF WTOTPRO > 0
      SELECT FACDCGE
      IF FILLOC()
         APPEND BLANK
         REPLACE NUMERO     WITH M.NUMERO
         REPLACE REFERENCIA WITH M.REFERENCIA
         REPLACE TIPPAC     WITH M.TIPPAC
         REPLACE CODPAC     WITH M.CODPAC
         REPLACE AREA       WITH WUBIC
         REPLACE ELABORADO  WITH M.ELABORADO
         REPLACE VENCE      WITH M.VENCE
         REPLACE SUBDOC     WITH M.SUBDOC
         REPLACE PORIMP     WITH M.PORIMP
         REPLACE SUBIMP     WITH M.SUBIMP
         REPLACE MONTO      WITH M.MONTO
         REPLACE ORIGEN     WITH "FAC"
         REPLACE DEPTO      WITH WUSERUBI
         REPLACE USUARIO    WITH WUSERCODE
         REPLACE USUARIOF   WITH DATE()
         STORE .T. TO WFLAGGEN
         FLUSH
         UNLOCK ALL
      ENDIF
   ENDIF
   SELECT SERDCGE
   IF RECLOC()
      REPLACE FACTURA WITH M.NUMERO
      FLUSH
      UNLOCK ALL
   ENDIF
ELSE
   *** GENERA CON CTAS DE ADMISION
   SELECT ADMADM
   SET ORDER TO ADMADM1
   SEEK M.REFERENCIA
   IF .NOT.FOUND()
      STORE WTIPREF+". No."+WNUMREF+" NO EXISTE, VERIFIQUE" TO WTEXT
      DO AVISO WITH WTEXT
      RETURN
   ENDIF
   *** VERIFICA QUE NO ESTE PROCESADO ADMINISTRATIVAMENTE
   IF FACTURA<>SPACE(10)
      STORE "CUENTA YA FUE FACTURADA CON DCTO. No.:"+SUBSTR(FACTURA,4,7) TO WTEXT
      DO AVISO WITH WTEXT
      RETURN
   ENDIF
   *IF TIPPAC="A"
   *   STORE "NO SE PUEDE FACTURAR A UN AFILIADO" TO WTEXT
   *   DO AVISO WITH WTEXT
   *   RETURN
   *ENDIF
   STORE TIPPAC    TO M.TIPPAC
   STORE CODPAC    TO M.CODPAC
   STORE UBICACION TO WUBIC
   STORE ALLTRIM(PAPELLIDO)+" "+ALLTRIM(PNOMBRE)+" ? (S/N)" TO TEX
   STORE "SN" TO WCH
   DO PREGUNTA
   IF WCH="N"
      RETURN
   ENDIF
   *** TRANSFIERE PRESUPUESTO
   DO FACINSPR
   *** TRANSFIERE COMPROBANTES
   SELECT SERDCGE
   SET ORDER TO SERDCGE4
   SEEK M.REFERENCIA
   DO WHILE .NOT. EOF() .AND. M.REFERENCIA=CUENTA .AND. SUBSTR(NUMERO,1,3)="COM"
      STORE NUMERO    TO WNUMDCTO
      STORE PROVEEDOR TO WAREA
      SELECT SERDCDE
      SEEK WNUMDCTO
      DO WHILE .NOT. EOF() .AND. NUMERO=WNUMDCTO
         STORE TIPITEM   TO WTIPITEM
         STORE ITEM      TO WITEM
         STORE CANTIDAD  TO WCANTIDAD
         STORE PRECIO    TO WPRECIO
         STORE EJECUTOR  TO WEJECUTOR
         STORE .F.       TO WFLAGESTA
         SELECT FACDCDE
         SEEK M.NUMERO
         DO WHILE .NOT.EOF().AND.NUMERO=M.NUMERO
            IF TIPITEM=WTIPITEM.AND.ITEM=WITEM.AND.EJECUTOR=WEJECUTOR
               STORE .T. TO WFLAGESTA
               EXIT
            ENDIF
            SELECT FACDCDE
            SKIP
         ENDDO
         IF .NOT. WFLAGESTA
            SELECT FACDCDE
            IF FILLOC()
               APPEND BLANK
               REPLACE NUMERO     WITH M.NUMERO
               REPLACE TIPITEM    WITH WTIPITEM
               REPLACE ITEM       WITH WITEM
               REPLACE AREA       WITH WAREA
               REPLACE EJECUTOR   WITH WEJECUTOR

               REPLACE ORIGEN     WITH "FAC"
               REPLACE DEPTO      WITH WUSERUBI
               REPLACE USUARIO    WITH WUSERCODE
               REPLACE USUARIOF   WITH DATE()
               FLUSH
               UNLOCK ALL
            ELSE
               STORE "OPERACION ABORTADA, REINTENTE" TO WTEXT
               DO AVISO WITH WTEXT
               RETURN
            ENDIF
         ENDIF
         IF RECLOC()
            REPLACE PRECIO     WITH ((CANTIDAD*PRECIO)+(WCANTIDAD*WPRECIO))/(WCANTIDAD+CANTIDAD)
            REPLACE CANTIDAD   WITH CANTIDAD+WCANTIDAD
            STORE .T.          TO WFLAGGEN




            STORE "PASO POR AQUI" TO WTEXT
            DO AVISO WITH WTEXT



            FLUSH
            UNLOCK ALL
         ELSE
            STORE "OPERACION ABORTADA, REINTENTE" TO WTEXT
            DO AVISO WITH WTEXT
            RETURN
         ENDIF
         SELECT SERDCDE
         SKIP
      ENDDO
      SELECT SERDCGE
      SKIP
   ENDDO
   IF WFLAGGEN
      *** CREA DATOS GENERALES DE FACTURA
      SELECT FACDCGE
      SEEK M.NUMERO
      IF .NOT.FOUND()
         IF FILLOC()
            APPEND BLANK
            REPLACE NUMERO     WITH M.NUMERO
            FLUSH
            UNLOCK ALL
         ELSE
            STORE "OPERACION ABORTADA, REINTENTE" TO WTEXT
            DO AVISO WITH WTEXT
            RETURN
         ENDIF
      ENDIF
      REPLACE REFERENCIA WITH M.REFERENCIA
      REPLACE TIPPAC     WITH M.TIPPAC
      REPLACE CODPAC     WITH M.CODPAC
      REPLACE AREA       WITH WUBIC

      REPLACE ORIGEN     WITH "FAC"
      REPLACE DEPTO      WITH WUSERUBI
      REPLACE USUARIO    WITH WUSERCODE
      REPLACE USUARIOF   WITH DATE()
      FLUSH
      UNLOCK ALL
      STORE RECNO()      TO WRECDOC

      *** MARCA LA DOCUMENTACION PROCESADA EN LA FACTURA
      SELECT SERDCGE
      SET ORDER TO SERDCGE4
      SEEK M.REFERENCIA
      DO WHILE .NOT. EOF() .AND. M.REFERENCIA=CUENTA
         IF RECLOC()
            REPLACE FACTURA WITH M.NUMERO
            FLUSH
            UNLOCK ALL
         ELSE
            STORE "MARCA DE DCTOS. PROCESADO FUE ABORTADA. REPITA LA OPERACION" TO WTEXT
            DO AVISO WITH WTEXT
            EXIT
         ENDIF
         SKIP
      ENDDO
      SELECT ADMADM
      SET ORDER TO ADMADM1
      SEEK M.REFERENCIA
      IF EOF()
         STORE WTIPREF+". No."+WNUMREF+" DESAPARECIO, REORGANICE INDICES Y REPITA" TO WTEXT
         DO AVISO WITH WTEXT
      ELSE
         IF RECLOC()
            REPLACE FACTURA WITH M.NUMERO
            FLUSH
            UNLOCK ALL
         ENDIF
      ENDIF
   ENDIF
ENDIF
RETURN

