*********************************************************************************
PROCEDURE INDICES
DEFI WIND WININD FROM 05,50 TO 07,72 ;
                 TITLE " REORGANIZAR " ;
                 DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
ACTI WIND WININD
@ 0,0 CLEAR
store 2 to wop
do while .t.
   store space(10) to wclaveind
   @ 00,00  say "Clave:" get wclaveind
   read
   if UPPER(wclaveind)<>"EJCM      "
      exit
   endif
   @ 00,00  get wop pict "@*H Aceptar ;Cancelar" defa wop
   read
   if lastkey()=13
      exit
   endif
enddo
if wop=1
   @ 00,00 
   @ 00,00 SAY "Favor esperar..."
else
   RELE WIND WININD
   RETURN
endif
***
SELECT CITOCU
IF FILLOC()
   INDEX ON CONSUL+DIA+STR(DESDEH,2)+STR(DESDEM,2) TO CITOCU1
   INDEX ON MEDICO+DIA+STR(DESDEH,2)+STR(DESDEM,2) TO CITOCU2
   UNLOCK ALL
ELSE
   STORE "OPERACION RECHAZADA, REINTENTE" TO WTEXT
   DO AVISO WITH WTEXT
ENDIF
***
SELECT CITCIT
IF FILLOC()
   INDEX ON MEDICO+DTOC(FECHA)+STR(HORA,2)+STR(MINUTO,2)       TO CITCIT1
   INDEX ON CODPAC+DTOC(FECHA)+STR(HORA,2)+STR(MINUTO,2)       TO CITCIT2
   INDEX ON CONSUL+DTOC(FECHA)+STR(HORA,2)+STR(MINUTO,2)       TO CITCIT3
   INDEX ON STR(YEAR(FECHA),4)+STR(MONTH(FECHA),2)+;
            STR(DAY(FECHA),2)+MEDICO+STR(HORA,2)+STR(MINUTO,2) TO CITCIT4
   INDEX ON SOLICITUD                                          TO CITCIT5
   INDEX ON MEDICO+STR(YEAR(FECHA),4)+STR(MONTH(FECHA),2)+;
            STR(DAY(FECHA),2)+STR(HORA,2)+STR(MINUTO,2)        TO CITCIT6
   UNLOCK ALL
ELSE
   STORE "OPERACION RECHAZADA, REINTENTE" TO WTEXT
   DO AVISO WITH WTEXT
ENDIF
***
SELECT CITPAC
IF FILLOC()
   INDEX ON CODPAC                                TO CITPAC
   UNLOCK ALL
ELSE
   STORE "OPERACION RECHAZADA, REINTENTE" TO WTEXT
   DO AVISO WITH WTEXT
ENDIF
***
STORE "EL SISTEMA SE REINICIARA, OPRIMA <ENTER> PARA CONTINUAR." TO WTEXT
DO AVISO WITH WTEXT
RELE WIND WININD
CLOSE DATA
CLOSE INDEX
SET PROC TO SYSPROC
RETURN TO MASTER
*****************
PROCEDURE COMPACTA
DEFI WIND WINCOM FROM 05,50 TO 07,72 ;
                 TITLE " COMPACTAR " ;
                 DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
ACTI WIND WINCOM
@ 0,0 CLEAR
store 2 to wop
do while .t.
   store space(10) to wclaveind
   @ 00,00  say "Clave:" get wclaveind
   read
   if UPPER(wclaveind)<>"EJCM      "
      exit
   endif
   @ 00,00  get wop pict "@*H Aceptar ;Cancelar" defa wop
   read
   if lastkey()=13
      exit
   endif
enddo
if wop=1
   @ 00,00 
   @ 00,00 SAY "Favor esperar..."
else
   RELE WIND WINCOM
   RETURN
endif
***
***
SELECT CITOCU 
IF FILLOC()
   PACK
   UNLOCK ALL
ELSE
   STORE "OPERACION RECHAZADA, REINTENTE" TO WTEXT
   DO AVISO WITH WTEXT
ENDIF
***
SELECT CITCIT 
IF FILLOC()
   PACK
   UNLOCK ALL
ELSE
   STORE "OPERACION RECHAZADA, REINTENTE" TO WTEXT
   DO AVISO WITH WTEXT
ENDIF
***
SELECT CITPAC 
IF FILLOC()
   PACK
   UNLOCK ALL
ELSE
   STORE "OPERACION RECHAZADA, REINTENTE" TO WTEXT
   DO AVISO WITH WTEXT
ENDIF
***
STORE "EL SISTEMA SE REINICIARA, OPRIMA <ENTER> PARA CONTINUAR." TO WTEXT
DO AVISO WITH WTEXT
RELE WIND WININD
CLOSE DATA
CLOSE INDEX
SET PROC TO SYSPROC
RETURN TO MASTER
****************
PROCEDURE RECLOC
DEFI WIND WINRLOCK FROM 12,05 TO 18,75 DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
ACTI WIND WINRLOCK
STORE .F. TO WFLAGRL
STORE .F. TO WRECMES
STORE .T. TO WRECLOC
DO WHILE WRECLOC
   IF RLOCK()
      STORE .T. TO WFLAGRL
      EXIT
   ELSE
      IF .NOT. WRECMES
         @ 02,15 SAY "REGISTRO OCUPADO POR OTRO USUARIO, REINTENTANDO ..."
         @ 03,15 SAY "          OPRIMA [ESC] PARA ABANDONAR              "
         STORE .T. TO WRECMES
      ENDIF
      WVALUE = INKEY()
      IF WVALUE = 27
         EXIT
      ENDIF
   ENDIF
ENDDO
RELEASE WIND WINRLOCK
RETURN WFLAGRL
******************************************************************************
PROCEDURE FILLOC
DEFI WIND WINFLOCK FROM 12,05 TO 18,75 DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 10
ACTI WIND WINFLOCK
STORE .F. TO WFLAGFL
STORE .F. TO WFILMES
STORE .T. TO WFILLOC
DO WHILE WFILLOC
   IF FLOCK()
      STORE .T. TO WFLAGFL
      EXIT
   ELSE
      IF .NOT. WFILMES
         @ 02,15 SAY "ARCHIVO  OCUPADO POR OTRO USUARIO, REINTENTANDO ..."
         @ 03,15 SAY "          OPRIMA [ESC] PARA ABANDONAR              "
         STORE .T. TO WFILMES
      ENDIF
      WVALUE = INKEY()
      IF WVALUE = 27
         EXIT
      ENDIF
   ENDIF
ENDDO
RELEASE WIND WINFLOCK
RETURN WFLAGFL
****************************************************************************
PROCEDURE PREGUNTA
STORE .T. TO WPREG
DO WHILE WPREG
   @ 23,0
   STORE SUBSTR(WCH,1,1) TO WCHOICE
   @ 23,40- (LEN(TEX)/2) SAY TEX GET WCHOICE
   READ
   STORE UPPER(WCHOICE) TO WCHOICE
   IF AT(WCHOICE,WCH) > 0
      STORE .F. TO WPREG
      EXIT
   ENDIF
ENDDO
@ 23,0
STORE WCHOICE TO WCH
RETURN
*************************
PROCEDURE MENSAJE
PARAMETERS WTEXT
DEFI WIND WINMES FROM 22,0 TO 24,79 DOUBLE  NOFLOAT;
                 NOZOOM NOGROW SHADOW COLOR SCHEME 10
ACTI WIND WINMES
@ 0,40-(LEN(WTEXT)/2) SAY WTEXT
RELE WIND WINMES
RETURN
*************************
PROCEDURE AVISO
PARAMETERS WTEXT
DEFI WIND WINAVI FROM 22,0 TO 24,79; 
                 DOUBLE NOFLOAT NOZOOM NOGROW SHADOW COLOR SCHEME 07
ACTI WIND WINAVI
?? CHR(7)
@ 0,40-(LEN(WTEXT)/2) SAY WTEXT
READ
RELE WIND WINAVI
RETURN
*************************
PROCEDURE CHKPRINT
PARAMETERS SALTAR
store .t. to wprinting
do while wprinting
   store "Prepare la impresora y oprima <ENTTER> para continuar o (R)echazar" to Qmes
   @ 23,1
   @ 23,40-(len(Qmes)/2) say Qmes
   store " " to wstat
   @ 23,78 get wstat
   read
   if upper(wstat) = "R"
      store 1 to saltar
      store .f. to wprinting
   else
      store 0 to saltar
      if sys(13) = "READY"
         store .f. to wprinting
      endif
   endif
   @ 23,1
enddo
RETURN
*************************
PROCEDURE ACCESO
PARAMETERS WPROGACC,WFLAGACC
STORE .T. TO WFLAGACC
IF USUARIOS->USERPRO <> SPACE(2)
   IF USUARIOS->USERPRO = "**"
      IF WPROGACC <> "05" .AND. PROGACC <> "12"
         STORE .F. TO WFLAGACC
      ENDIF
   ELSE
      IF USUARIOS->USERPRO <> WPROGACC
         STORE .F. TO WFLAGACC
      ENDIF
   ENDIF
ENDIF
RETURN
*************************
PROCEDURE STRNUMBER
STORE LEN(RTRIM(LTRIM(STR(WNUMBERN,12)))) TO WNUMLEN
STORE REPLICATE("0",12-WNUMLEN)+LTRIM(STR(WNUMBERN,12)) TO WNUMBERC
RETURN
*************************
PROCEDURE ARMACOD
STORE LEN(CITCIT.CODPAC)                              TO WLEN
STORE AT(" ",CITCIT.CODPAC)                           TO WPOS
STORE SUBSTR(CITCIT.CODPAC,1,(WPOS-1))                TO WPART1
STORE LTRIM(SUBSTR(CITCIT.CODPAC,WPOS,(WLEN-WPOS)+1)) TO WPART2
STORE WPART1+"-"+WPART2                               TO WXCODPAC
RETURN
**************************
PROCEDURE ARMANOM
IF TIPPAC="A"
   SELECT AFIAFI
   SET ORDER TO 1
   SEEK CITCIT.CODPAC
   IF FOUND()
      STORE ALLTRIM(PAPELLIDO)+" "+;
            SUBSTR(SAPELLIDO,1,1)+","+;
            ALLTRIM(PNOMBRE)+" "+;
            SUBSTR(SNOMBRE,1,1)           TO WNOMBRE
      STORE HISTORIA                      TO WHISTORIA
      STORE (DATE()-NACIMIENTO)/365       TO WEDAD
      STORE DIRECCION                     TO WDIRE
   ELSE
      STORE "NO REGISTRADO"               TO WNOMBRE,WHISTORIA,WDIRE
      STORE 0                             TO WEDAD
   ENDIF
ELSE
   SELECT CITPAC
   SEEK CITCIT.CODPAC
   IF FOUND()
      STORE ALLTRIM(PAPELLIDO)+" "+;
      SUBSTR(SAPELLIDO,1,1)+". "+;
      ALLTRIM(PNOMBRE)+" "+;
      SUBSTR(SNOMBRE,1,1)+"."       TO WNOMBRE
      STORE HISTORIA                TO WHISTORIA
      STORE (DATE()-NACIMIENTO)/365 TO WEDAD
      STORE DIRECCION               TO WDIRE
   ELSE
      STORE "NO REGISTRADO" TO WNOMBRE,WHISTORIA,WDIRE
      STORE 0               TO WEDAD
   ENDIF
ENDIF
RETURN
*************************
PROCEDURE CHKACC
PARAMETERS WUSERCODE,WPROGRAMA,WACCESO,WFILTRO
SELECT SYSUSERD
STORE WUSERCODE+WPROGRAMA TO WCLAVEACC
SEEK WCLAVEACC
IF FOUND()
   STORE ACCESO TO WACCESO
   STORE FILTRO TO WFILTRO
ENDIF
RETURN
******************
